<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">-->
    <!--<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>-->
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>-->
    
    
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.2.0/d3.min.js" integrity="sha512-C2RveGuPIWqkaLAluvoxyiaN1XYNe5ss11urhZWZYBUA9Ydgj+hfGKPcxCzTwut1/fmjEZR7Ac35f2aycT8Ogw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-selection/1.2.0/d3-selection.min.js" integrity="sha512-P/PLNIojUNrUq2g5Q3NX8epp5X6KZmNvWV2pDGU+ZiU96YlqFhIrG0pkSZ/qgruT7uJ2Ok/vFN7/7brl4Y7ipw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-scale/1.0.7/d3-scale.min.js" integrity="sha512-CagQ2MAkdTRJK0ge/Q/+y2QL+0wvabHP7y7GIKwy7E5aptPLpHu26CDi3Ec95xkYPMvZBqjNOwe02NZoBqWXIg==" crossorigin="anonymous"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-transition/1.1.1/d3-transition.min.js" integrity="sha512-9EoVFaJ1f642H4qLe+VUMu7CDqa1FQPdar1Pm76aS1AeesQoMdmm3NUZaZlJ1H/IEpwfS1Hbq41l/iUmhxq8jw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-time/1.0.8/d3-time.min.js" integrity="sha512-UPE7yiWEYDz8P9wbryFMvk4XRktIUjV1Z5rQcmAsIgRelE9GAZ+6Z8jtGcaOUYEvz8aaoDWpDZXkhGbMkeWPQQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-time-format/2.1.1/d3-time-format.min.js" integrity="sha512-RTLi1scS97v4q3+HK402bvUoRK7qwXoZytagrAsw+B6gVzTAiVXEzGW/L60XEd0N63qgB9NnSXzLv7gi1FcXFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-collection/1.0.5/d3-collection.min.js" integrity="sha512-wYLIhsNaJ6cBEcFIgAtY0ncVV3KEzE95+32OfOdQJQkEfZVrWOn+N2woUPaBCuW8N6S7++72Y7XlOPZ/3U7X2w==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-geo-projection/2.4.0/d3-geo-projection.min.js" integrity="sha512-GsBgCSYNatBlhNZQPrXtlHydWMCi+rl7QyR5Fs5kNwczI8XdKqZ7ZZ+yGnEfhvekkgSiAW0KGM5o7q+OHqhutQ==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@2.0.0/dist/d3-scale-chromatic.min.js" integrity="sha256-6j4tMdLVRyhccNbjkfHgQCTYUmR68g0v9a+MvHPd2yI=" crossorigin="anonymous"></script>
   


  </head>
  <body>
    
  <style>


  .hi {
    width:500px;
  }

  </style>
  
  <nav class="navbar fixed-top navbar-expand-sm navbar-light bg-light position-absolute position-fixed">
    <a class="navbar-brand" href="#">Illinois COVID-19 Modeling</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse buttons hi" id="navbarNav">
      <ul class="navbar-nav list "id = "navList">
        
           <li class="nav-item">
              <a class="nav-link" href="/"  class="current" >Home</a>
            </li>
        
           <li class="nav-item">
              <a class="nav-link" href="/reports.html" >Reports</a>
            </li>
        
           <li class="nav-item">
              <a class="nav-link" href="/about.html" >About</a>
            </li>
        
      </ul>
    </div>
    
    <div class = "container position-relative ">
    <div class = "row">
        <div class = "col drop ">
            <select id="selectButton" class = "dropdown "  ></select>
        </div>
    </div>
</div>

  </nav>
    <style>
/*div {*/
/*   border: 1px solid red;*/
/*}*/
/*.bottom {*/
/*   height: 200px;*/
/*   position: relative;*/
/*}*/
    .card {
    border-color:transparent !important;
    }
    .chart {
        z-index: 1;
        /*margin-bottom: 1%;*/
        
    }
    body {
        padding-top: 50px;
        padding-bottom:300px;
}
	.classy {
      fill:#009DAA;
    } 
 
   #cases_map {
      /*z-index: 2;*/   
      position: fixed;
      z-index: 2;
   }
   .card-body {
      /*width: 100%;*/
      margin-right: 20px;
   }
   /*.pos {*/
   /*   float: right;*/
   /*   position: relative;*/
   /*}*/

@media only screen and (max-width: 339px) {
      body {
         padding-top: 110px;
      }
      #cases_map {
         width: 20%;
         /*margin-top: 30px*/
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }
}


@media only screen and (min-width: 339px) {
      body {
         padding-top: 75px;
         margin-right: 0%;
      }
      #cases_map {
         width: 20%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }

}

/* Small devices (portrait tablets and large phones, 600px and up) */
@media only screen and (min-width: 600px) {
      #cases_map {
         width: 18%;
      }
      body {
         padding-top: 70px;
      }
      #cases_map {
         width: 15%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
         margin-right: 0%;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }
}

/* Medium devices (landscape tablets, 768px and up) */
@media only screen and (min-width: 768px) {
      
      #cases_map {
         width: 15%;
      }
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Large devices (laptops/desktops, 992px and up) */
@media only screen and (min-width: 992px) {
   body{
      /*margin-left: 5%;*/
      margin-right: 10%;
   }
   #cases_map {
      margin-left: 1%;
         width: 10%;
}
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Extra large devices (large laptops and desktops, 1200px and up) */
@media only screen and (min-width: 1200px) {
   
      body{
      /*margin-left: 5%;*/
      margin-right: 12%;
   }
   #cases_map {
         width: 10%;
      }
}

</style>

<div class="map" id = "cases_map"></div>


<div class="card rt " id = "">
  <div class="card-body">
    <h2>Transmission Status</h2>
    <text>We estimate Rt is currently around <text id = "rt_text"></text> (95% CI <text id = "rt_text_lower"></text>-<text id = "rt_text_upper"></text>) for the state of Illinois. Rt, the instantanous
      reproductive number, tells us whether the epidemic is <i>growing</i> (Rt > 1), <i>shrinking</i> (Rt < 1), or
      staying the same (Rt = 1).</text>
  </div>
</div>

<div class = "card rt chart">
   <div class="card-body" id = "rt_chart"> </div>
</div>


<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases</h2>
    <text>Subtitle for cases chart </text>
  </div>
</div>

<div class = "card cases chart">
   <div class="card-body" id = "cases_chart"> </div>
</div>


<div class="card deaths " id = "">
  <div class="card-body">
    <h2>Deaths</h2>
    <text>Subtitle for deaths chart </text>
  </div>
</div>

<div class = "card deaths chart">
   <div class="card-body" id = "deaths_chart"> </div>
</div>

<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases per Test (case positivity rate)</h2>
    <text>Subtitle for test chart </text>
  </div>
</div>

<!--<div class = "card deaths chart">-->
<!--<div id="my_dataviz"></div>-->
<!--</div>-->


<div class = "card deaths chart">
<div id="test_pos"></div>
</div>
<div class="card cases " id = "">
  <div class="card-body">
    <h2>Tests</h2>
    <text>Subtitle for test chart </text>
  </div>
</div>


<div class = "card deaths chart">
<div id="tests"></div>
</div>


<div id="bottom"></div>
<script>
   /* global d3 */
   /* global $ */

   
   function LightenDarkenColor(col,amt) {
      var usePound = false;
      if ( col[0] == "#" ) {
         col = col.slice(1);
         usePound = true;
      }
      var num = parseInt(col,16);
      
      var r = (num >> 16) + amt;
      if ( r > 255 ) r = 255;
      else if  (r < 0) r = 0;
      
      var b = ((num >> 8) & 0x00FF) + amt;
      if ( b > 255 ) b = 255;
      else if  (b < 0) b = 0;
      
      var g = (num & 0x0000FF) + amt;
      if ( g > 255 ) g = 255;
      else if  ( g < 0 ) g = 0;
      
      return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
   }
   
//  //orginal colors sent
//    var hexColors = ["#BA3E39", "#BA7FB7","#89D0C5", "#F9B554", "#969696", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#DCC29C"]
//    var mapFill = ["#740000", "#743971", "#438a7f", "#b36f0e", "#505050", "#777396", "#ae3928", "#396797", "#6d8f1a", "#b38197", "#a48500", "#967c56"]
//    var hexColorsLight = ["#c0514c", "#c08bbe","#94d4ca", "#f9bc65", "#a0a0a0", "#c3c0df", "#f58b7c", "#8bb5e0", "#bad96f", "#f9cce0", "#ecd056", "#dfc8a5"]
//    var hexColorsLighter = ["#c76460", "#c798c5","#a0d9d0", "#fac376", "#ababab", "#cac7e3", "#f6988b", "#98bde3", "#c2dd7f", "#fad2e3", "#eed569", "#e3ceaf"]
//    var hexColorsLightest = ["#ce7774", "#cea5cc","#acded6", "#facb87", "#b5b5b5", "#d0cee6", "#f7a599", "#a5c5e7", "#c9e18f", "#fad7e7", "#f0da7c", "#e6d4b9"]
   
   //region color swap issue #29
   var hexColors = ["#969696", "#BA7FB7","#89D0C5", "#F9B554", "#DCC29C", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#BA3E39"] 
   
   var mapFill = ["#505050", "#743971", "#438a7f", "#b36f0e", "#967c56", "#777396", "#ae3928", "#396797", "#6d8f1a", "#b38197", "#a48500", "#740000"]

   var hexColorsLight = ["#a0a0a0", "#c08bbe","#94d4ca", "#f9bc65", "#dfc8a5", "#c3c0df", "#f58b7c", "#8bb5e0", "#bad96f", "#f9cce0", "#ecd056", "#c0514c"]

   var hexColorsLighter = ["#ababab", "#c798c5","#a0d9d0", "#fac376", "#e3ceaf", "#cac7e3", "#f6988b", "#98bde3", "#c2dd7f", "#fad2e3", "#eed569", "#c76460"]

   var hexColorsLightest = ["#b5b5b5", "#cea5cc","#acded6", "#facb87", "#e6d4b9", "#d0cee6", "#f7a599", "#a5c5e7", "#c9e18f", "#fad7e7", "#f0da7c", "#ce7774"]

   var firstIteration = true;
   // var i;
   // for (i = 0; i < mapFill.length; i++) {
   //    mapFill[i] = LightenDarkenColor(mapFill[i], -70)
   // }
   // console.log(mapFill)
   
   let allGroup = ["illinois", "covidregion_1", "covidregion_2", "covidregion_3", 
                   "covidregion_4", "covidregion_5", "covidregion_6", "covidregion_7", 
                   "covidregion_8", "covidregion_9", "covidregion_10", "covidregion_11"]

     d3.select("#selectButton")
    .selectAll('myOptions')
    .data(allGroup)
    .enter()
    .append('option')
    .text(function (d) { 
                         if(d == "illinois" ||d == "Illinois" ) {
                              return "Illinois";
                          }
                          d = "Region " + d.substring( d.indexOf('_')+1);
                          return d; 
                        })
    .attr("value", function (d) { return d; })
    .attr("class", "dropdown-item")
    
    var mapFillColor = d3.scaleOrdinal().domain(allGroup)
   //  .range(hexColorsLight)
     .range(mapFill)
     
    var colors = d3.scaleOrdinal().domain(allGroup)
   //  .range(hexColorsLight)
     .range(hexColors)
     
   var lightColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLight)
     
   var lighterColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLighter)
     
   var lightestColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLightest)
  
   
   var countyMap = {
      "ADAMS": {
         "covid_region": 3
      },
      "ALEXANDER": {
         "covid_region": 5
      },
      "BOND": {
         "covid_region": 4
      },
      "BOONE": {
         "covid_region": 1
      },
      "BROWN": {
         "covid_region": 3
      },
      "BUREAU": {
         "covid_region": 2
      },
      "CALHOUN": {
         "covid_region": 3
      },
      "CARROLL": {
         "covid_region": 1
      },
      "CASS": {
         "covid_region": 3
      },
      "CHAMPAIGN": {
         "covid_region": 6
      },
      "CHICAGO": {
         "covid_region": 11
      },
      "CHRISTIAN": {
         "covid_region": 3
      },
      "CLARK": {
         "covid_region": 6
      },
      "CLAY": {
         "covid_region": 6
      },
      "CLINTON": {
         "covid_region": 4
      },
      "COLES": {
         "covid_region": 6
      },
      "COOK": {
         "covid_region": 10
      },
      "CRAWFORD": {
         "covid_region": 6
      },
      "CUMBERLAND": {
         "covid_region": 6
      },
      "DE WITT": {
         "covid_region": 6
      },
      "DEKALB": {
         "covid_region": 1
      },
      "DOUGLAS": {
         "covid_region": 6
      },
      "DUPAGE": {
         "covid_region": 8
      },
      "EDGAR": {
         "covid_region": 6
      },
      "EDWARDS": {
         "covid_region": 5
      },
      "EFFINGHAM": {
         "covid_region": 6
      },
      "FAYETTE": {
         "covid_region": 6
      },
      "FORD": {
         "covid_region": 6
      },
      "FRANKLIN": {
         "covid_region": 5
      },
      "FULTON": {
         "covid_region": 2
      },
      "GALLATIN": {
         "covid_region": 5
      },
      "GREENE": {
         "covid_region": 3
      },
      "GRUNDY": {
         "covid_region": 2
      },
      "HAMILTON": {
         "covid_region": 5
      },
      "HANCOCK": {
         "covid_region": 3
      },
      "HARDIN": {
         "covid_region": 5
      },
      "HENDERSON": {
         "covid_region": 2
      },
      "HENRY": {
         "covid_region": 2
      },
      "IROQUOIS": {
         "covid_region": 6
      },
      "JACKSON": {
         "covid_region": 5
      },
      "JASPER": {
         "covid_region": 6
      },
      "JEFFERSON": {
         "covid_region": 5
      },
      "JERSEY": {
         "covid_region": 3
      },
      "JO DAVIESS": {
         "covid_region": 1
      },
      "JOHNSON": {
         "covid_region": 5
      },
      "KANE": {
         "covid_region": 8
      },
      "KANKAKEE": {
         "covid_region": 7
      },
      "KENDALL": {
         "covid_region": 2
      },
      "KNOX": {
         "covid_region": 2
      },
      "LAKE": {
         "covid_region": 9
      },
      "LASALLE": {
         "covid_region": 2
      },
      "LAWRENCE": {
         "covid_region": 6
      },
      "LEE": {
         "covid_region": 1
      },
      "LIVINGSTON": {
         "covid_region": 2
      },
      "LOGAN": {
         "covid_region": 3
      },
      "MACON": {
         "covid_region": 6
      },
      "MACOUPIN": {
         "covid_region": 3
      },
      "MADISON": {
         "covid_region": 4
      },
      "MARION": {
         "covid_region": 5
      },
      "MARSHALL": {
         "covid_region": 2
      },
      "MASON": {
         "covid_region": 3
      },
      "MASSAC": {
         "covid_region": 5
      },
      "MCDONOUGH": {
         "covid_region": 2
      },
      "MCHENRY": {
         "covid_region": 9
      },
      "MCLEAN": {
         "covid_region": 2
      },
      "MENARD": {
         "covid_region": 3
      },
      "MERCER": {
         "covid_region": 2
      },
      "MONROE": {
         "covid_region": 4
      },
      "MONTGOMERY": {
         "covid_region": 3
      },
      "MORGAN": {
         "covid_region": 3
      },
      "MOULTRIE": {
         "covid_region": 6
      },
      "OGLE": {
         "covid_region": 1
      },
      "PEORIA": {
         "covid_region": 2
      },
      "PERRY": {
         "covid_region": 5
      },
      "PIATT": {
         "covid_region": 6
      },
      "PIKE": {
         "covid_region": 3
      },
      "POPE": {
         "covid_region": 5
      },
      "PULASKI": {
         "covid_region": 5
      },
      "PUTNAM": {
         "covid_region": 2
      },
      "RANDOLPH": {
         "covid_region": 4
      },
      "RICHLAND": {
         "covid_region": 6
      },
      "ROCK ISLAND": {
         "covid_region": 2
      },
      "SALINE": {
         "covid_region": 5
      },
      "SANGAMON": {
         "covid_region": 3
      },
      "SCHUYLER": {
         "covid_region": 3
      },
      "SCOTT": {
         "covid_region": 3
      },
      "SHELBY": {
         "covid_region": 6
      },
      "ST. CLAIR": {
         "covid_region": 4
      },
      "STARK": {
         "covid_region": 2
      },
      "STEPHENSON": {
         "covid_region": 1
      },
      "TAZEWELL": {
         "covid_region": 2
      },
      "UNION": {
         "covid_region": 5
      },
      "VERMILION": {
         "covid_region": 6
      },
      "WABASH": {
         "covid_region": 5
      },
      "WARREN": {
         "covid_region": 2
      },
      "WASHINGTON": {
         "covid_region": 4
      },
      "WAYNE": {
         "covid_region": 5
      },
      "WHITE": {
         "covid_region": 5
      },
      "WHITESIDE": {
         "covid_region": 1
      },
      "WILL": {
         "covid_region": 7
      },
      "WILLIAMSON": {
         "covid_region": 5
      },
      "WINNEBAGO": {
         "covid_region": 1
      },
      "WOODFORD": {
         "covid_region": 2
      }
   }
   
      var margin_rt = {top: 15, right: 10, bottom: 50, left: 45};
   var margin_cases = {top: 15, right: 10, bottom: 50, left: 60};
   var margin_deaths = {top: 15, right: 10, bottom: 50, left: 40};
   var margin_test_pos = {top: 15, right: 30, bottom: 50, left: 60};
   var margin_tests = {top: 15, right: 10, bottom: 50, left: 60};
   

   // var map_wid = document.getElementById("cases_map").offsetWidth;
   // var map_hid = map_wid *2;
   
   
   var svg_rt = d3.select("#rt_chart").append("svg")    
   .style("fill", "none")
    .style("pointer-events", "all")
    .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  )
   
   var x_rt = d3.scaleTime();
   var x_rt_axis = svg_rt.append("g");
   var y_rt = d3.scaleLinear();
   var y_rt_axis = svg_rt.append("g");
   
   var interval_rt = svg_rt.append("path")
      .attr("stroke", "none")
      .attr("transform", "translate("+ 0 +","+ 0  + ")"  );
   
   var line_rt = svg_rt.append('g').append("path")  
   .attr("transform", "translate("+ 0 +","+ 0  + ")"  )
      // .attr("transform", "translate("+ (margin_rt.left+2) +","+ margin_rt.top  + ")"  )
      .style("stroke-width", 2)
      .style("fill", "none");
      
   var refLine = svg_rt.append('g').append("path")      .attr("stroke", "black")
   .attr("transform", "translate("+ 0 +","+ 0  + ")"  )
      // .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  )
      .style("stroke-width", 1)
      .style("stroke-dasharray", ("3, 3"))
      .style("fill", "none")
   
   var dataFilter = null; 
   

   
   var svg_deaths = d3.select("#deaths_chart").append("svg")
	var svg_map = d3.select("#cases_map").append("svg")
	var svg_cases = d3.select("#cases_chart").append("svg")
	var svg_test_pos = d3.select("#test_pos").append("svg")
	var svg_tests = d3.select("#tests").append("svg")


// // append the svg object to the body of the page
//     var yTitle = svg_rt.append("text")
//       .attr("transform", "rotate(-90)")
//       .attr("y", 4)
//       // .attr("x",0 - (height / 2))
//       .attr("dy", "1em")
//       .style("text-anchor", "middle")
//       .text("Rt");    




	 // This allows to find the closest X index of the mouse:
  var bisect = d3.bisector(function(d) { return d.date; }).left;

 // Create the circle that travels along the curve of chart
 var focus = d3.select("#rt_chart")
    .append('g')
    .append('circle')
      .style("fill", "none")
      .attr("stroke", "black")
      .attr('r', 4.5)
      .style("opacity", 0)
      .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  );

   var Tooltip = d3.select("#rt_chart")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")
    
    
var Tooltip_cases_line = d3.select("#cases_chart")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")
   
   
   		var projection = d3.geoAlbers()
   		var path = d3.geoPath()
	
	var selectedRegion = 'illinois';


var x_cases = d3.scaleBand()
var y_cases = d3.scaleLinear()

var x_axis = svg_cases.append("g")
var y_axis = svg_cases.append("g")



var x_deaths= d3.scaleBand()
var y_deaths = d3.scaleLinear()

var x_axis_deaths = svg_deaths.append("g")
var y_axis_deaths = svg_deaths.append("g")



var x_test_pos= d3.scaleBand()
var y_test_pos = d3.scaleLinear()
var y_test_pos2 = d3.scaleLinear()

var x_axis_tests_pos = svg_test_pos.append("g")
var y_axis_tests_pos = svg_test_pos.append("g")
var y_axis_tests_pos2 = svg_test_pos.append("g")


var x_tests= d3.scaleBand()
var y_tests = d3.scaleLinear()
var x_axis_tests = svg_tests.append("g")
var y_axis_tests = svg_tests.append("g")
	
// 	var files = ['https://raw.githubusercontent.com/samhovie/sitefiles/main/il-counties.json', 
// 	           'https://raw.githubusercontent.com/samhovie/sitefiles/main/nu_20201027.csv',
// 	           'https://raw.githubusercontent.com/samhovie/sitefiles/main/NOFO_long.csv']

var files = [
             'https://raw.githubusercontent.com/samhovie/sitefiles/main/il-counties.json', 
             'https://raw.githubusercontent.com/samhovie/sitefiles/main/nu_20201027.csv',
             'https://docs.google.com/spreadsheets/d/1MWNebArAjjTTtJdxQcnUakShSbADhccx3xw28L2Nflo/gviz/tq?tqx=out:csv&sheet=NOFO_long'
            ]
             
	           

var promises = [];

files.forEach(function(url) {
    if (url.slice(-1) === 'n'){
       promises.push(d3.json(url))
    }else{
       promises.push(d3.csv(url))
    }
});

Promise.all(promises).then(function(data) {
   
   // console.log(data[2])
 
//clean rt    
let parseDate = d3.timeParse("%Y-%m-%d");
let today = new Date();
var index = data[1].length - 1;

while (index >= 0) {
     if(isNaN(data[1][index].rt_median) || 
          data[1][index].scenario_name !== 'baseline' ||
          parseDate(data[1][index].date) > today  
      ){
         data[1].splice(index, 1);
      } else {
         data[1][index].rt_lower = +data[1][index].rt_lower;
         data[1][index].rt_median = +data[1][index].rt_median;
         data[1][index].rt_upper = +data[1][index].rt_upper;
         data[1][index].date = parseDate(data[1][index].date);
      }
  index -= 1;
}

//clean cases/deaths
  var prev_cases = 0;
  var prev_region = "";
  var prev_deaths = 0;
  var prev_test = 0;
  var cases_max_diff = {};
  var deaths_max_diff = {};
  var tests_max_diff = {};
//   parseDate = d3.timeParse("%Y-%m-%d");
// var a = true;
data[2].forEach((d) => {
    d.update_date = (d.update_date).substr(0,(d.update_date).indexOf(' '))
    d.update_date = parseDate(d.update_date);
    d.Positive_Cases = +d.Positive_Cases
    d.Tested = +d.Tested
    d.Deaths = +d.Deaths;
    d.new_cases = 0;
    d.new_deaths = 0;
    d.new_tests = 0;
    
    //if it's a new region (different from last line)
   if ((prev_region.localeCompare(d.NOFO_Region)) !== 0) {
      cases_max_diff[d.NOFO_Region] = 0;
      deaths_max_diff[d.NOFO_Region] = 0;
      tests_max_diff[d.NOFO_Region] = 0;
      
      prev_cases = d.Positive_Cases;
      d.new_cases = d.Positive_Cases;
      
      prev_deaths = d.Deaths;
      d.new_deaths = d.Deaths;
      
      prev_test = d.Tested;
      d.new_tests = d.Tested;
      
      prev_region = d.NOFO_Region;
    } else {
       
      if (d.Positive_Cases < prev_cases) {
         d.new_cases = 0;
      } else {
         d.new_cases = d.Positive_Cases - prev_cases;
      }
      
      if (d.Deaths < prev_deaths) {
         d.new_deaths = 0;
      } else {
         d.new_deaths = d.Deaths - prev_deaths;
      }
      
      if (d.Tested < prev_test) {
         d.new_tests = 0;
      } else {
         d.new_tests = d.Tested - prev_test;
      }
      
      if( d.new_cases > cases_max_diff[d.NOFO_Region] ) {
         cases_max_diff[d.NOFO_Region] = d.new_cases;
      }
      if( d.new_deaths > deaths_max_diff[d.NOFO_Region] ) {
         deaths_max_diff[d.NOFO_Region] = d.new_deaths;
      } 
      if( d.new_tests > tests_max_diff[d.NOFO_Region] ) {
         tests_max_diff[d.NOFO_Region] = d.new_tests;
      } 
      //get rid of initial backlog 
      if (d.new_tests === 137404) {
         // console.log(d.new_tests)
         d.new_tests = 0;
      }
      if (d.new_tests > d.new_cases) {
         d.test_positivity = d.new_cases / d.new_tests
      } else if (d.new_tests < d.new_cases){
        d.test_positivity = .18
      } else {
         d.test_positivity = 0
      }

      prev_cases = d.Positive_Cases;
      prev_deaths = d.Deaths;
      prev_test = d.Tested;
      prev_region = d.NOFO_Region;
    }
    
    
  });

function drawChart() {
   



   
   
   // console.log(data[1])
   // console.log(data[2])
   
   let dict = {};
      dict["illinois"] = "Illinois";
      dict["covidregion_1"] = "Central";
      dict["covidregion_2"] = "Chicago";
      dict["covidregion_3"] = "Collar";
      dict["covidregion_4"] = "West Central";
      dict["covidregion_5"] = "North Central";
      dict["covidregion_6"] = "Northern";
      dict["covidregion_7"] = "Northwest";
      dict["covidregion_8"] = "Southeast Central";
      dict["covidregion_9"] = "Southern";
      dict["covidregion_10"] = "Southwest Central";
      dict["covidregion_11"] = "Suburban";

      var currentWidth = document.getElementById("rt_chart").offsetWidth;
      
      const width_rt = currentWidth- margin_rt.left - margin_rt.right;
      let height_rt = parseInt(currentWidth * 0.35 ) - margin_rt.top - margin_rt.bottom;

      if (parseInt(currentWidth) < 600) {
         height_rt = parseInt(currentWidth * .72) - margin_rt.top - margin_rt.bottom;
         // console.log("hi")
      }
      else if (parseInt(currentWidth) < 900) {
         height_rt = parseInt(currentWidth * .62) - margin_rt.top - margin_rt.bottom;
      }

      currentWidth = document.getElementById("cases_chart").offsetWidth;
      const width_cases = currentWidth- margin_cases.left - margin_cases.right;
      let height_cases = parseInt(currentWidth * 0.35 ) - margin_cases.top - margin_cases.bottom;
      
      if (parseInt(currentWidth) < 600) {
         height_cases = parseInt(currentWidth * .72) - margin_cases.top - margin_cases.bottom;
      }
      else if (parseInt(currentWidth) < 900) {
         height_cases = parseInt(currentWidth * .62) - margin_cases.top - margin_cases.bottom;
      }
      
   var map_wid = document.getElementById("cases_map").offsetWidth;
   var map_hid = map_wid *2;
   
   svg_map.attr("width", map_wid )
	       .attr("height", map_hid)
	       
   projection.rotate([89.5,0]).fitWidth(map_wid, data[0]);
   
   path.projection(projection);
  
   // var map = svg_map.append("g")
   svg_map.append("g")
   
       var map = svg_map.selectAll("path")
       .data(data[0].features)
       
       map.enter()
       .append("path")
       .merge(map)
       .attr( "d", path )
       .attr("fill", function(d){ 
         if (selectedRegion.localeCompare("illinois") === 0) {
            // console.log('hi')
            return colors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region])
         } else {
             if (countyMap[d.properties.COUNTY_NAM].covid_region === parseInt(selectedRegion.split('_')[1])) {
                   return colors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
            } else {
                     return "#7E7E7E" 
            }
         }
      })
      .attr("stroke", function(d){ 
	                 
           if (selectedRegion.localeCompare("illinois") === 0) {
               return mapFillColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region])
            } else {
           if (
             countyMap[d.properties.COUNTY_NAM].covid_region ===
             parseInt(selectedRegion.split('_')[1])) {
                   return mapFillColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
            } else {
               return "#AAAAAA" 
            }
         }
      }) 
      
   map
   .exit()
   .remove()
 

   var dataFilter = data[1].filter(function(d){return d.geography_modeled==selectedRegion}) 

    document.getElementById('rt_text').innerHTML = (dataFilter[dataFilter.length - 1 ].rt_median).toFixed(2);
    document.getElementById('rt_text_lower').innerHTML = (dataFilter[dataFilter.length - 1 ].rt_lower).toFixed(2);
    document.getElementById('rt_text_upper').innerHTML = (dataFilter[dataFilter.length - 1 ].rt_upper).toFixed(2);
    
    
    
     // Three function that change the tooltip when user hover / move / leave a cell
//  var mouseover = function(d) {
//     focus.style("opacity", 1)
//     Tooltip
//       .style("opacity", 1)
//    //  d3.select(this)
//    //    .style("stroke", "black")
//    //    .style("opacity", 1)
//  }
    var mouseover_cases = function(d) {
     focus.style("opacity", 1)
    Tooltip
      .style("opacity", 1)

  }
  
  var mousemove = function(d) {
         // var formatTime = d3.timeFormat("%b %d")"%b %Y"
         var formatTime = d3.timeFormat("%b %d")
    var x0 = x_rt.invert(d3.mouse(this)[0]);
    var i = bisect(dataFilter, x0, 1);
    var selectedData = dataFilter[i]
    Tooltip
      .html("<h6>"+ formatTime(selectedData.date) +"<br>" +"R<sub>t</sub>: "+  parseFloat((selectedData.rt_median)).toFixed(2) +"</h6>")
      // .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("left", (x_rt(selectedData.date)+90) + "px")
      .style("top",  (y_rt(selectedData.rt_median)+40) + "px")
   focus
      .attr("cx", x_rt(selectedData.date))
      .attr("cy", y_rt(selectedData.rt_median))
  }
  
  
//  var mouseleave = function(d) {
//     focus.style("opacity", 0)
//     Tooltip
//       .style("opacity", 0)
//  }
  
  console.log (dataFilter)
    x_rt.domain(d3.extent(data[1] , function(d) { return d.date}))
   //  x_rt.domain(dataFilter.map(function(d) { return d.date; }))
    
   //  .range([ margin_rt.left, width_rt-margin_rt.left ]);
    .range([ margin_rt.left, width_rt-margin_rt.left ]);
                  
   //y_rt.domain([0, d3.max(data.filter(function(d){return d.geography_modeled==allGroup[0]}), function(d) { return d.rt_upper })])
   
   y_rt.domain([0, 2.1]);
   
   
   
   
         svg_rt.attr("width", width_rt + margin_rt.left + margin_rt.right)
      .attr("height", height_rt + margin_rt.top + margin_rt.bottom)
      .append("g")
    .attr("transform",
          "translate(" + margin_rt.left + "," + margin_rt.top + ")");
   
      
      x_rt_axis
       .attr("transform", "translate(" + 0 + "," + height_rt + ")")
      
      if (currentWidth < 600) {
         x_rt_axis.call(d3.axisBottom(x_rt).ticks(3));
      }else {
         x_rt_axis.call(d3.axisBottom(x_rt).ticks(6));
      }
      
      
      
      
      
      y_rt.range([ height_rt, 0 ])
      y_rt_axis.attr("transform", "translate("+ margin_rt.left +","+ 0 + ")"  ).call(d3.axisLeft(y_rt).ticks(6))


   svg_rt.select(".xLabel").remove()
   svg_rt.select(".yLabel").remove()
   
   svg_rt.append("text")
    .attr("class", "yLabel")
    .attr("text-anchor", "end")
    .attr("y", 6)
            .attr("transform",
            "translate(" + -10 + " ," + 
                           0 + ")")
   //  .attr("opacity", .8)
    .attr("dy", ".75em")
    .style("fill", "#242526")
    
    .attr("transform", "rotate(-90)")
    .text("Rate of Transmission (Rt)") 
        
        
        svg_rt.append("text") 
        .attr("class", "xLabel")
        .attr("transform",
            "translate(" + (width_rt/2) + " ," + 
                           (height_rt + margin_rt.top + 30) + ")")
      .style("text-anchor", "middle")
      .style("fill", "#242526")
      .text("Date") 

   interval_rt
      .datum(dataFilter)
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      .transition()
      .duration(1000)
      .attr("d", d3.area()
      .x(function(d) { return x_rt(d.date) })
      .y0(function(d) { return y_rt(d.rt_lower) })
      .y1(function(d) { return y_rt(d.rt_upper) }))
   
   line_rt
      .datum(dataFilter)
      .attr("stroke", function(d){ return colors(selectedRegion) })
      .transition()
      .duration(1000)
      .attr("d", d3.line()
      .x(function(d) { return x_rt(d.date) })
      .y(function(d) { return y_rt(d.rt_median) })
      )
   
   refLine
      .datum(dataFilter)
      .transition()
      .duration(1000)
      .attr("d", d3.line()
      .x(function(d) { return x_rt(d.date) })
      .y(function(d) { return y_rt(1.0) }));

   svg_rt
      .append('rect')
      .attr('width', width_rt)
      .attr('height', height_rt)
      .on("mouseover", function(d) {
     focus.style("opacity", 1)
    Tooltip
      .style("opacity", 1)
  })
      .on("mousemove", mousemove)
      .on("mouseleave", function(d) {
     focus.style("opacity", 0)
    Tooltip
      .style("opacity", 0)
  })
   

   var selectedGroupCases = dict[selectedRegion]
   
   svg_cases
    .attr("width", width_cases + margin_cases.left + margin_cases.right)
    .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin_cases.left + "," + margin_cases.top + ")");
   
      svg_test_pos
    .attr("width", width_cases + margin_test_pos.left + margin_test_pos.right)
    .attr("height", height_cases + margin_test_pos.top + margin_test_pos.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin_test_pos.left + "," + margin_test_pos.top + ")");
          
   svg_tests
    .attr("width", width_cases + margin_tests.left + margin_tests.right)
    .attr("height", height_cases + margin_tests.top + margin_tests.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin_tests.left + "," + margin_tests.top + ")");
   
   
   var data_map = data[2].filter(function(d){return d.NOFO_Region==selectedGroupCases})
   
const formatTime = d3.timeFormat("%b %Y");
  const len = data_map.length - 1;

  x_cases.domain(data_map.map(function(d) { return d.update_date; }))
  .range([0,width_cases])
  .padding(0);
  
  x_test_pos.domain(data_map.map(function(d) { return d.update_date; }))
  .range([0,width_cases])
  .padding(0);
  
    x_tests.domain(data_map.map(function(d) { return d.update_date; }))
  .range([0,width_cases])
  .padding(0);
  
//  x_axis.attr("transform", "translate(0," + height + ")")
 x_axis
 .attr("transform", "translate(" + margin_cases.left + "," + (height_cases+margin_cases.top) + ")")
//  .attr("transform", "translate(" + 0 + "," + height_cases + ")")
  .call(d3.axisBottom(x_cases)
  .tickValues(x_cases.domain().filter(function(d,i){ return !(i%30)}))
   //  .tickValues(tickValuesForAxis)
    .tickFormat((d, i) => {
      var r = '';
      var dt = d; //console.log(d)
      if ((i%30) || i == len) r = formatTime(dt);
      return r;
       })
    );
    
       svg_cases.select(".xLabel").remove()
   
    
       svg_cases.append("text")
    .attr("text-anchor", "end")
    .attr("y", 6)
   //  .attr("opacity", .8)
    .attr("dy", ".75em")
    .style("fill", "#242526")
    
    .attr("transform", "rotate(-90)")
   //  .text("Number") 
        
        
        svg_cases.append("text") 
        .attr("class", "xLabel")
        .attr("transform",
            "translate(" + (width_cases/2) + " ," + 
                           (height_cases + margin_cases.top+40) + ")")
      .style("text-anchor", "middle")
      .style("fill", "#242526")
      .text("Date") 

    
 x_axis_tests_pos
 .attr("transform", "translate(" + margin_test_pos.left + "," + (height_cases+margin_test_pos.top) + ")")
  .call(d3.axisBottom(x_test_pos)
  .tickValues(x_test_pos.domain().filter(function(d,i){ return !(i%30)}))
   //  .tickValues(tickValuesForAxis)
    .tickFormat((d, i) => {
      var r = '';
      var dt = d; //console.log(d)
      if ((i%30) || i == len) r = formatTime(dt);
      return r;
       })
    );
    
           svg_deaths.select(".xLabel").remove()
    
            svg_deaths.append("text") 
            .attr("class", "xLabel")
        .attr("transform",
            "translate(" + (width_cases/2) + " ," + 
                           (height_cases + margin_cases.top+40) + ")")
      .style("text-anchor", "middle")
      .style("fill", "#242526")
      .text("Date") 

 x_axis_tests
 .attr("transform", "translate(" + margin_tests.left + "," + (height_cases+margin_tests.top) + ")")
  .call(d3.axisBottom(x_tests)
  .tickValues(x_tests.domain().filter(function(d,i){ return !(i%30)}))
   //  .tickValues(tickValuesForAxis)
    .tickFormat((d, i) => {
      var r = '';
      var dt = d; //console.log(d)
      if ((i%30) || i == len) r = formatTime(dt);
      return r;
       })
    );
    svg_tests.select(".xLabel").remove()
    
                svg_tests.append("text") 
                .attr("class", "xLabel")
        .attr("transform",
            "translate(" + (width_cases/2) + " ," + 
                           (height_cases + margin_cases.top+40) + ")")
      .style("text-anchor", "middle")
      .style("fill", "#242526")
      .text("Date") 
      
      svg_test_pos.select(".xLabel").remove()
    
                svg_test_pos.append("text") 
                .attr("class", "xLabel")
        .attr("transform",
            "translate(" + (width_cases/2) + " ," + 
                           (height_cases + margin_cases.top+40) + ")")
      .style("text-anchor", "middle")
      .style("fill", "#242526")
      .text("Date") 
    
  y_cases
  .domain([0, d3.max(data_map, function(d) { return d.new_cases; })])
  .range([height_cases, 0]);
  
    y_test_pos
//  .domain([0, d3.max(data_map, function(d) { return d.new_tests; })])
  .domain([0, 120000])
  
  .range([height_cases, 0]);
  
      y_test_pos2
  .domain([0, d3.max(data_map, function(d) { return d.test_positivity; })])
  .domain([0, .20])
  
  .range([height_cases, 0]);
  
      y_tests
  .domain([0, d3.max(data_map, function(d) { return d.new_tests; })])
  .range([height_cases, 0]);
  
// var y_axis = svg.append("g")
y_axis.attr("transform", "translate("+ (margin_cases.left-2) +","+ margin_cases.top  + ")"  ).call(d3.axisLeft(y_cases));

// y_axis_tests_pos.attr("transform", "translate("+ (margin_tests.left-2) +","+ margin_tests.top  + ")"  ).call(d3.axisLeft(y_test_pos));
var formatPercent = d3.format(".0%");
// y_axis_tests_pos2.attr("transform", "translate("+ (width_cases+ margin_test_pos.left+2) +","+ margin_test_pos.top  + ")"  ).call(d3.axisRight(y_test_pos2).tickFormat(formatPercent))
y_axis_tests_pos2.attr("transform", "translate("+ (margin_tests.left-2) +","+ margin_tests.top  + ")"  ).call(d3.axisLeft(y_test_pos2).tickFormat(formatPercent))

y_axis_tests.attr("transform", "translate("+ (margin_tests.left-2) +","+ margin_tests.top  + ")"  ).call(d3.axisLeft(y_tests));


       var s = svg_tests.selectAll(".bar1")
    .data(data_map)
   
   // svg_test_pos.selectAll(".bar1")
   //  .data(data_map)
    s.enter().append("rect").merge(s)
   //  .transition()
   //  .duration(1000)
      .attr("class", "bar1")
      .attr("x", function(d) { return x_tests(d.update_date)})
      .attr("y", function(d) { return y_tests(d.new_tests); })
      .attr("width",  x_tests.bandwidth())
      .attr("height", function(d) { return height_cases - y_tests(d.new_tests); })
      .attr("fill", function(d){ return lightestColors(selectedRegion) }).attr("transform", "translate("+ margin_tests.left +","+margin_tests.top + ")"  );
      

      s
    .exit()
    .remove()
      
      
       const POINTS_AVERAGE = 6;
 var line_test_daily = d3
    .line()
    .x(d => x_tests(d.update_date))
    .y((d, i, data_map) => {
      var r,
       avg = 0;
      for (let j = 0; j <= POINTS_AVERAGE; j++) {
       if (i - j >= 0) {
          avg += y_tests(data_map[i - j].new_tests);
          r = Math.floor(avg / (j + 1));
       } else {
          r = Math.floor(avg / j);
          j = POINTS_AVERAGE + 1;
       }
      }
      //  console.log(i, r, y_test_pos2(d.test_positivity));
       
      //  if (isNaN(r)) r = 0
      return r;
    });

// console.log(line_tests)

svg_tests.selectAll('path').remove();
  
 svg_tests
    .append('path')
    .datum(data_map)
    .attr('fill', 'none')
   //  .attr('stroke', '#000000')
   .attr("stroke", function(d){ return colors(selectedRegion) })
    .attr('stroke-width', 2.5)
    .attr('stroke-linejoin', 'round')
    .attr('stroke-linecap', 'round')
    .attr('d', line_test_daily).attr("transform", "translate("+ margin_tests.left +","+ margin_tests.top  + ")"  );
   //     var t = svg_test_pos.selectAll(".bar1")
   //  .data(data_map)
   
   // // svg_test_pos.selectAll(".bar1")
   // //  .data(data_map)
   //  t.enter().append("rect").merge(t)
   // //  .transition()
   // //  .duration(1000)
   //    .attr("class", "bar1")
   //    .attr("x", function(d) { return x_test_pos(d.update_date)})
   //    .attr("y", function(d) { return y_test_pos(d.new_tests); })
   //    .attr("width",  x_test_pos.bandwidth())
   //    .attr("height", function(d) { return height_cases - y_test_pos(d.new_tests); })
   //    .attr("fill", function(d){ return lightestColors(selectedRegion) })
      

   //    t
   //  .exit()
   //  .remove()
    
   //    var b =  svg_test_pos.selectAll(".bar2")
   //  .data(data_map)
    
   //  b.enter().append("rect").merge(b)
   // //  .transition()
   // //  .duration(1000)
   //    .attr("class", "bar2")
   //    .attr("x", function(d) { return x_test_pos(d.update_date)})
   //    .attr("y", function(d) { return y_test_pos(d.new_cases); })
   //    .attr("width",  x_test_pos.bandwidth())
   //    .attr("height", function(d) { return height_cases - y_test_pos(d.new_cases); })
   //    .attr("fill", function(d){ return colors(selectedRegion) })   
      
   // b
   //  .exit()
   //  .remove()
      
    
   // // u
   // svg_test_pos.selectAll("rect").attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );


//  const POINTS_AVERAGE = 6;
 var line_tests = d3
    .line()
    .x(d => x_test_pos(d.update_date))
    .y((d, i, data_map) => {
      var r,
       avg = 0;
      for (let j = 0; j <= POINTS_AVERAGE; j++) {
       if (i - j >= 0) {
          avg += y_test_pos2(data_map[i - j].test_positivity);
          r = Math.floor(avg / (j + 1));
       } else {
          r = Math.floor(avg / j);
          j = POINTS_AVERAGE + 1;
       }
      }
      //  console.log(i, r, y_test_pos2(d.test_positivity));
       
       if (isNaN(r)) r = 0
      return r;
    });

// console.log(line_tests)

svg_test_pos.selectAll('path').remove();
  
 svg_test_pos
    .append('path')
    .datum(data_map)
    .attr('fill', 'none')
   //  .attr('stroke', '#000000')
   .attr("stroke", function(d){ return colors(selectedRegion) })
    .attr('stroke-width', 2.5)
    .attr('stroke-linejoin', 'round')
    .attr('stroke-linecap', 'round')
    .attr('d', line_tests).attr("transform", "translate("+ margin_tests.left +","+ margin_tests.top  + ")"  );





  // Create the u variable
  var u = svg_cases.selectAll("rect")
    .data(data_map)

  u
    .enter()
    .append("rect") // Add a new rect for each new elements
    .merge(u) // get the already existing elements as well
      .attr("x", function(d) { return x_cases(d.update_date); })
      .attr("y", function(d) { return y_cases(d.new_cases); })
      .attr("width", x_cases.bandwidth())
      // .attr("height", function(d) { return height - y(d.new_cases); })
      .attr("height", function(d) { return height_cases - y_cases(d.new_cases); })
      
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      // .attr("transform", "translate(" + margin.left + "," + height + ")")

  // If less group in the new dataset, I delete the ones not in use anymore
  u
    .exit()
    .remove()
    
   // u
   svg_cases.selectAll("rect").attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );
    
//  const POINTS_AVERAGE = 6;
 var line = d3
    .line()
    .x(d => x_cases(d.update_date))
    .y((d, i, data_map) => {
      var r,
        avg = 0;
      for (let j = 0; j <= POINTS_AVERAGE; j++) {
        if (i - j >= 0) {
          avg += y_cases(data_map[i - j].new_cases);
          r = Math.floor(avg / (j + 1));
        } else {
          r = Math.floor(avg / j);
          j = POINTS_AVERAGE + 1;
        }
      }
      //  console.log(i, r, y(d.count));
      return r;
    });

svg_cases.selectAll('path').remove();
  
  svg_cases
  
    .append('path')
    .datum(data_map)
    .attr('fill', 'none')
   //  .attr('stroke', '#000000')
   .attr("stroke", function(d){ return colors(selectedRegion) })
    .attr('stroke-width', 2.5)
    .attr('stroke-linejoin', 'round')
    .attr('stroke-linecap', 'round')
    .attr('d', line).attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  );

   
   svg_deaths
    .attr("width", width_cases + margin_cases.left + margin_cases.right)
    .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
  .append("g")
  
    .attr("transform",
          "translate(" + margin_cases.left + "," + margin_cases.top + ")");


  x_deaths.domain(data_map.map(function(d) { return d.update_date; }))
  .range([0,width_cases])
  .padding(0);
  

//  x_axis.attr("transform", "translate(0," + height + ")")
 x_axis_deaths
 .attr("transform", "translate(" + margin_cases.left + "," + (height_cases+margin_cases.top) + ")")
  .call(d3.axisBottom(x_deaths)
  .tickValues(x_deaths.domain().filter(function(d,i){ return !(i%30)}))
   //  .tickValues(tickValuesForAxis)
    .tickFormat((d, i) => {
      var r = '';
      var dt = d; //console.log(d)
      if ((i%30) || i == len) r = formatTime(dt);
      return r;
       })
    );

  y_deaths
  .domain([0, d3.max(data_map, function(d) { return d.new_deaths; })])
  .range([height_cases, 0]);
// var y_axis = svg.append("g")
 y_axis_deaths.attr("transform", "translate("+ (margin_cases.left-2) +","+ margin_cases.top  + ")"  ).call(d3.axisLeft(y_deaths));

  // Create the u variable
  var i = svg_deaths.selectAll("rect")
    .data(data_map)

  i
    .enter()
    .append("rect") // Add a new rect for each new elements
    .merge(i) // get the already existing elements as well
      .attr("x", function(d) { return x_deaths(d.update_date); })
      .attr("y", function(d) { return y_deaths(d.new_deaths); })
      .attr("width", x_deaths.bandwidth())
      // .attr("height", function(d) { return height - y(d.new_cases); })
      .attr("height", function(d) { return height_cases - y_deaths(d.new_deaths); })
      
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      // .attr("transform", "translate(" + margin.left + "," + height + ")")

  // If less group in the new dataset, I delete the ones not in use anymore
  i
    .exit()
    .remove()
    
   // u
   svg_deaths.selectAll("rect").attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );
    
//  const POINTS_AVERAGE = 6;
 var lineA = d3
    .line()
    .x(d => x_deaths(d.update_date))
    .y((d, i, data_map) => {
      var r,
        avg = 0;
      for (let j = 0; j <= POINTS_AVERAGE; j++) {
        if (i - j >= 0) {
          avg += y_deaths(data_map[i - j].new_deaths);
          r = Math.floor(avg / (j + 1));
        } else {
          r = Math.floor(avg / j);
          j = POINTS_AVERAGE + 1;
        }
      }
    //   console.log(i, r, y(d.count));
      return r;
    });

svg_deaths.selectAll('path').remove();
  
  svg_deaths
    .append('path')
    .datum(data_map)
    .attr('fill', 'none')
   //  .attr('stroke', '#000000')
    .attr("stroke", function(d){ return colors(selectedRegion) })
    .attr('stroke-width', 2.5)
    .attr('stroke-linejoin', 'round')
    .attr('stroke-linecap', 'round')
    .attr('d', lineA)
    .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  );
    
    
    

    }
    // Initialize the chart
    drawChart();
    // console.log("done")
    // Add an event listener that run the function when dimension change
    window.addEventListener('resize', drawChart ); 
    // console.log("hi")
          // When the button is changed, run the updateChart funso ction
    d3.select("#selectButton").on("change", function(d) {
      // recover the option that has been chosen
      // var selectedOption = d3.select(this).property("value")
       selectedRegion = d3.select(this).property("value")
      // run the updateChart function with this selected option
      // console.log(selectedOption)
      drawChart()
    })
}); //Promise.all    

</script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>
