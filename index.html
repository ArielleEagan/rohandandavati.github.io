---
layout: default
title: Home
---
<style>
div {
   border: 1px solid red;
}
    .card {
    border-color:transparent !important;
    }
    .chart {
        z-index: 1;
        /*margin-bottom: 1%;*/
        
    }
    body {
        padding-top: 50px;
}
	.classy {
      fill:#009DAA;
    } 
 
   #cases_map {
      /*z-index: 2;*/   
      position: fixed;
      z-index: 2;
   }
   .card-body {
      /*width: 100%;*/
      margin-right: 20px;
   }
   /*.pos {*/
   /*   float: right;*/
   /*   position: relative;*/
   /*}*/

@media only screen and (max-width: 339px) {
      body {
         padding-top: 100px;
      }
      #cases_map {
         width: 20%;
         /*margin-top: 30px*/
         /*border: solid red 1px;*/
      }
      .rt {
         width: 80%;
         float: right;
      }
      .cases {
         width: 80%;
         float: right;
      }
      .deaths {
         width: 80%;
         float: right;
      }
}


@media only screen and (min-width: 339px) {
      body {
         padding-top: 75px;
         margin-right: 0%;
      }
      #cases_map {
         width: 20%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 80%;
         float: right;
      }
      .cases {
         width: 80%;
         float: right;
      }
      .deaths {
         width: 80%;
         float: right;
      }

}

/* Small devices (portrait tablets and large phones, 600px and up) */
@media only screen and (min-width: 600px) {
      #cases_map {
         width: 18%;
      }
      body {
         padding-top: 70px;
      }
      #cases_map {
         width: 15%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 85%;
         float: right;
         margin-right: 0%;
      }
      .cases {
         width: 85%;
         float: right;
      }
      .deaths {
         width: 85%;
         float: right;
      }
}

/* Medium devices (landscape tablets, 768px and up) */
@media only screen and (min-width: 768px) {
      
      #cases_map {
         width: 15%;
      }
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Large devices (laptops/desktops, 992px and up) */
@media only screen and (min-width: 992px) {
   body{
      /*margin-left: 5%;*/
      margin-right: 10%;
   }
   #cases_map {
      margin-left: 1%;
         width: 10%;
}
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Extra large devices (large laptops and desktops, 1200px and up) */
@media only screen and (min-width: 1200px) {
   
      body{
      /*margin-left: 5%;*/
      margin-right: 12%;
   }
   #cases_map {
         width: 10%;
      }
}

</style>

<div class="map" id = "cases_map"></div>


<div class="card rt " id = "">
  <div class="card-body">
    <h2>Transmission Status</h2>
    <text>We estimate Rt is currently around 1.2 (95% CI 1.11-1.28) for the state of Illinois. Rt, the instantanous
      reproductive number, tells us whether the epidemic is <i>growing</i> (Rt > 1), <i>shrinking</i> (Rt < 1), or
      staying the same (Rt = 1).</text>
  </div>
</div>

<div class = "card rt chart">
   <div class="card-body" id = "rt_chart"> </div>
</div>


<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases</h2>
    <text>Subtitle for cases chart </text>
  </div>
</div>

<div class = "card cases chart">
   <div class="card-body" id = "cases_chart"> </div>
</div>


<div class="card deaths " id = "">
  <div class="card-body">
    <h2>Deaths</h2>
    <text>Subtitle for deaths chart </text>
  </div>
</div>

<div class = "card deaths chart">
   <div class="card-body" id = "deaths_chart"> </div>
</div>

<div class = "card deaths chart">
<div id="my_dataviz"></div>
</div>


<script>
   /* global d3 */
   /* global $ */
   
   

   /*
   TODO
   -organize drawChart - no need to set width at the end - make adding futher interaction easier
   -rt hover detail to html- fix cutoff - move on if no luck - done
   -add case positivity rate chart 
   -cases an deaths to bar charts 
   -add moving average
   
   */
   
   
   
   

   
   function LightenDarkenColor(col,amt) {
      var usePound = false;
      if ( col[0] == "#" ) {
         col = col.slice(1);
         usePound = true;
      }
      var num = parseInt(col,16);
      
      var r = (num >> 16) + amt;
      if ( r > 255 ) r = 255;
      else if  (r < 0) r = 0;
      
      var b = ((num >> 8) & 0x00FF) + amt;
      if ( b > 255 ) b = 255;
      else if  (b < 0) b = 0;
      
      var g = (num & 0x0000FF) + amt;
      if ( g > 255 ) g = 255;
      else if  ( g < 0 ) g = 0;
      
      return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
   }
   
  //orginal colors sent
   var hexColors = ["#BA3E39", "#BA7FB7","#89D0C5", "#F9B554", "#969696", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#DCC29C"]
   
   // var mapFill = ["#BA3E39", "#BA7FB7","#89D0C5", "#F9B554", "#969696", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#DCC29C"]
   var mapFill = ["#740000", "#743971", "#438a7f", "#b36f0e", "#505050", "#777396", "#ae3928", "#396797", "#6d8f1a", "#b38197", "#a48500", "#967c56"]
   
   var hexColorsLight = ["#c0514c", "#c08bbe","#94d4ca", "#f9bc65", "#a0a0a0", "#c3c0df", "#f58b7c", "#8bb5e0", "#bad96f", "#f9cce0", "#ecd056", "#dfc8a5"]
   
   var hexColorsLighter = ["#c76460", "#c798c5","#a0d9d0", "#fac376", "#ababab", "#cac7e3", "#f6988b", "#98bde3", "#c2dd7f", "#fad2e3", "#eed569", "#e3ceaf"]
   
   var hexColorsLightest = ["#ce7774", "#cea5cc","#acded6", "#facb87", "#b5b5b5", "#d0cee6", "#f7a599", "#a5c5e7", "#c9e18f", "#fad7e7", "#f0da7c", "#e6d4b9"]
   
   
   // var i;
   // for (i = 0; i < mapFill.length; i++) {
   //    mapFill[i] = LightenDarkenColor(mapFill[i], -70)
   // }
   // console.log(mapFill)
   
   let allGroup = ["illinois", "covidregion_1", "covidregion_2", "covidregion_3", 
                   "covidregion_4", "covidregion_5", "covidregion_6", "covidregion_7", 
                   "covidregion_8", "covidregion_9", "covidregion_10", "covidregion_11"]

     d3.select("#selectButton")
    .selectAll('myOptions')
    .data(allGroup)
    .enter()
    .append('option')
    .text(function (d) { 
                         if(d == "illinois" ||d == "Illinois" ) {
                              return "Illinois";
                          }
                          d = "Region " + d.substring( d.indexOf('_')+1);
                          return d; 
                        })
    .attr("value", function (d) { return d; })
    .attr("class", "dropdown-item")
    
    var mapFillColor = d3.scaleOrdinal().domain(allGroup)
   //  .range(hexColorsLight)
     .range(mapFill)
     
    var Colors = d3.scaleOrdinal().domain(allGroup)
   //  .range(hexColorsLight)
     .range(hexColors)
     
   var lightColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLight)
     
   var lighterColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLighter)
     
   var lightestColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLightest)
  
   
   var countyMap = {
      "ADAMS": {
         "covid_region": 3
      },
      "ALEXANDER": {
         "covid_region": 5
      },
      "BOND": {
         "covid_region": 4
      },
      "BOONE": {
         "covid_region": 1
      },
      "BROWN": {
         "covid_region": 3
      },
      "BUREAU": {
         "covid_region": 2
      },
      "CALHOUN": {
         "covid_region": 3
      },
      "CARROLL": {
         "covid_region": 1
      },
      "CASS": {
         "covid_region": 3
      },
      "CHAMPAIGN": {
         "covid_region": 6
      },
      "CHICAGO": {
         "covid_region": 11
      },
      "CHRISTIAN": {
         "covid_region": 3
      },
      "CLARK": {
         "covid_region": 6
      },
      "CLAY": {
         "covid_region": 6
      },
      "CLINTON": {
         "covid_region": 4
      },
      "COLES": {
         "covid_region": 6
      },
      "COOK": {
         "covid_region": 10
      },
      "CRAWFORD": {
         "covid_region": 6
      },
      "CUMBERLAND": {
         "covid_region": 6
      },
      "DE WITT": {
         "covid_region": 6
      },
      "DEKALB": {
         "covid_region": 1
      },
      "DOUGLAS": {
         "covid_region": 6
      },
      "DUPAGE": {
         "covid_region": 8
      },
      "EDGAR": {
         "covid_region": 6
      },
      "EDWARDS": {
         "covid_region": 5
      },
      "EFFINGHAM": {
         "covid_region": 6
      },
      "FAYETTE": {
         "covid_region": 6
      },
      "FORD": {
         "covid_region": 6
      },
      "FRANKLIN": {
         "covid_region": 5
      },
      "FULTON": {
         "covid_region": 2
      },
      "GALLATIN": {
         "covid_region": 5
      },
      "GREENE": {
         "covid_region": 3
      },
      "GRUNDY": {
         "covid_region": 2
      },
      "HAMILTON": {
         "covid_region": 5
      },
      "HANCOCK": {
         "covid_region": 3
      },
      "HARDIN": {
         "covid_region": 5
      },
      "HENDERSON": {
         "covid_region": 2
      },
      "HENRY": {
         "covid_region": 2
      },
      "IROQUOIS": {
         "covid_region": 6
      },
      "JACKSON": {
         "covid_region": 5
      },
      "JASPER": {
         "covid_region": 6
      },
      "JEFFERSON": {
         "covid_region": 5
      },
      "JERSEY": {
         "covid_region": 3
      },
      "JO DAVIESS": {
         "covid_region": 1
      },
      "JOHNSON": {
         "covid_region": 5
      },
      "KANE": {
         "covid_region": 8
      },
      "KANKAKEE": {
         "covid_region": 7
      },
      "KENDALL": {
         "covid_region": 2
      },
      "KNOX": {
         "covid_region": 2
      },
      "LAKE": {
         "covid_region": 9
      },
      "LASALLE": {
         "covid_region": 2
      },
      "LAWRENCE": {
         "covid_region": 6
      },
      "LEE": {
         "covid_region": 1
      },
      "LIVINGSTON": {
         "covid_region": 2
      },
      "LOGAN": {
         "covid_region": 3
      },
      "MACON": {
         "covid_region": 6
      },
      "MACOUPIN": {
         "covid_region": 3
      },
      "MADISON": {
         "covid_region": 4
      },
      "MARION": {
         "covid_region": 5
      },
      "MARSHALL": {
         "covid_region": 2
      },
      "MASON": {
         "covid_region": 3
      },
      "MASSAC": {
         "covid_region": 5
      },
      "MCDONOUGH": {
         "covid_region": 2
      },
      "MCHENRY": {
         "covid_region": 9
      },
      "MCLEAN": {
         "covid_region": 2
      },
      "MENARD": {
         "covid_region": 3
      },
      "MERCER": {
         "covid_region": 2
      },
      "MONROE": {
         "covid_region": 4
      },
      "MONTGOMERY": {
         "covid_region": 3
      },
      "MORGAN": {
         "covid_region": 3
      },
      "MOULTRIE": {
         "covid_region": 6
      },
      "OGLE": {
         "covid_region": 1
      },
      "PEORIA": {
         "covid_region": 2
      },
      "PERRY": {
         "covid_region": 5
      },
      "PIATT": {
         "covid_region": 6
      },
      "PIKE": {
         "covid_region": 3
      },
      "POPE": {
         "covid_region": 5
      },
      "PULASKI": {
         "covid_region": 5
      },
      "PUTNAM": {
         "covid_region": 2
      },
      "RANDOLPH": {
         "covid_region": 4
      },
      "RICHLAND": {
         "covid_region": 6
      },
      "ROCK ISLAND": {
         "covid_region": 2
      },
      "SALINE": {
         "covid_region": 5
      },
      "SANGAMON": {
         "covid_region": 3
      },
      "SCHUYLER": {
         "covid_region": 3
      },
      "SCOTT": {
         "covid_region": 3
      },
      "SHELBY": {
         "covid_region": 6
      },
      "ST. CLAIR": {
         "covid_region": 4
      },
      "STARK": {
         "covid_region": 2
      },
      "STEPHENSON": {
         "covid_region": 1
      },
      "TAZEWELL": {
         "covid_region": 2
      },
      "UNION": {
         "covid_region": 5
      },
      "VERMILION": {
         "covid_region": 6
      },
      "WABASH": {
         "covid_region": 5
      },
      "WARREN": {
         "covid_region": 2
      },
      "WASHINGTON": {
         "covid_region": 4
      },
      "WAYNE": {
         "covid_region": 5
      },
      "WHITE": {
         "covid_region": 5
      },
      "WHITESIDE": {
         "covid_region": 1
      },
      "WILL": {
         "covid_region": 7
      },
      "WILLIAMSON": {
         "covid_region": 5
      },
      "WINNEBAGO": {
         "covid_region": 1
      },
      "WOODFORD": {
         "covid_region": 2
      }
   }

   // var map_wid = document.getElementById("cases_map").offsetWidth;
   // var map_hid = map_wid *2;
   
   var margin_rt = {top: 10, right: 10, bottom: 50, left: 70};
   var svg_rt = d3.select("#rt_chart").append("svg")
   
   var x_rt = d3.scaleTime();
   var x_rt_axis = svg_rt.append("g");
   var y_rt = d3.scaleLinear();
   var y_rt_axis = svg_rt.append("g");
   
   var interval_rt = svg_rt.append("path");
   var line_rt = svg_rt.append('g').append("path");
   var refLine = svg_rt.append('g').append("path")
   
   var dataFilter = null; 
   
   var margin_cases = {top: 15, right: 10, bottom: 50, left: 40};
   var margin_deaths = {top: 15, right: 10, bottom: 50, left: 40};

   var svg_deaths = d3.select("#deaths_chart").append("svg")


    var xTitle = svg_rt.append("text")
      .style("text-anchor", "middle")
      .text("");
      
    var yTitle = svg_rt.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 4)
      // .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Rt");     
	var svg_map = d3.select("#cases_map")
	            .append("svg")


// append the svg object to the body of the page
var svg_cases = d3.select("#cases_chart").append("svg")
	 // This allows to find the closest X index of the mouse:
  var bisect = d3.bisector(function(d) { return d.date; }).left;

  // Create the circle that travels along the curve of chart
  var focus = svg_rt
    .append('g')
    .append('circle')
      .style("fill", "none")
      .attr("stroke", "black")
      .attr('r', 8.5)
      .style("opacity", 0).attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  );

  // Create the text that travels along the curve of chart
  var focusText = svg_rt
    .append('g')
    .append('text')
      .style("opacity", 0)
      .attr("text-anchor", "left")
      .attr("alignment-baseline", "middle").attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  );

   
   		var projection = d3.geoAlbers()
   		var path = d3.geoPath()
	
	
	var files = ['https://raw.githubusercontent.com/samhovie/sitefiles/main/il-counties.json', 
	           'https://raw.githubusercontent.com/samhovie/sitefiles/main/nu_20201027.csv',
	           'https://raw.githubusercontent.com/samhovie/sitefiles/main/NOFO_long.csv']

var promises = [];

files.forEach(function(url) {
    if (url.slice(-1) === 'n'){
       promises.push(d3.json(url))
    }else{
       promises.push(d3.csv(url))
    }
});

Promise.all(promises).then(function(data) {
   
   console.log(data[2])
 
//clean rt    
let parseDate = d3.timeParse("%Y-%m-%d");
let today = new Date();
var index = data[1].length - 1;

while (index >= 0) {
     if(isNaN(data[1][index].rt_median) || 
          data[1][index].scenario_name !== 'baseline' ||
          parseDate(data[1][index].date) > today  
      ){
         data[1].splice(index, 1);
      } else {
         data[1][index].rt_lower = +data[1][index].rt_lower;
         data[1][index].rt_median = +data[1][index].rt_median;
         data[1][index].rt_upper = +data[1][index].rt_upper;
         data[1][index].date = parseDate(data[1][index].date);
      }
  index -= 1;
}

//clean cases/deaths
  var prev_cases = 0;
  var prev_region = "";
  var prev_deaths = 0;
  var cases_max_diff = {};
  var deaths_max_diff = {};
//   parseDate = d3.timeParse("%Y-%m-%d");

data[2].forEach((d) => {
    d.update_date = (d.update_date).substr(0,(d.update_date).indexOf(' '))
    d.update_date = parseDate(d.update_date);
    d.Positive_Cases = +d.Positive_Cases
    d.Tested = +d.Tested
    d.Deaths = +d.Deaths;
    d.new_cases = 0;
    d.new_deaths = 0;
    
    if ((prev_region.localeCompare(d.NOFO_Region)) !== 0) {
      //  console.log(d.NOFO_Region)
       cases_max_diff[d.NOFO_Region] = 0;
       deaths_max_diff[d.NOFO_Region] = 0;
       
       prev_cases = d.Positive_Cases;
       d.new_cases = d.Positive_Cases;
       
      prev_deaths = d.Deaths;
      d.new_deaths = d.Deaths;
      prev_region = d.NOFO_Region;
    } else {
      if (d.Positive_Cases < prev_cases) {
         d.new_cases = 0;
      } else {
         d.new_cases = d.Positive_Cases - prev_cases;
      }
      
      if (d.Deaths < prev_deaths) {
         d.new_deaths = 0;
         
      } else {
         d.new_deaths = d.Deaths - prev_deaths;
      }
      if( d.new_cases > cases_max_diff[d.NOFO_Region] ) {
         cases_max_diff[d.NOFO_Region] = d.new_cases;
      }
      if( d.new_deaths > deaths_max_diff[d.NOFO_Region] ) {
         deaths_max_diff[d.NOFO_Region] = d.new_deaths;
      } 
       prev_cases = d.Positive_Cases;
       prev_deaths = d.Deaths;
       prev_region = d.NOFO_Region;
    }  
  });

var selectedRegion = 'illinois';


var x_cases = d3.scaleBand()
var y_cases = d3.scaleLinear()

var x_axis = svg_cases.append("g")
var y_axis = svg_cases.append("g")


var x_deaths= d3.scaleBand()
var y_deaths = d3.scaleLinear()

var x_axis_deaths = svg_deaths.append("g")
var y_axis_deaths = svg_deaths.append("g")


function drawChart() {
   
   

   var map_wid = document.getElementById("cases_map").offsetWidth;
   var map_hid = map_wid *2;
   
   svg_map.attr("width", map_wid )
	       .attr("height", map_hid)
	       
   // console.log(map_wid)
   
   // projection.rotate([89.5,0]).fitSize([map_wid, map_hid], data[0]);
   projection.rotate([89.5,0]).fitWidth(map_wid, data[0]);
   
   path.projection(projection);
  
   // var map = svg_map.append("g")
   svg_map.append("g")
   
       var map = svg_map.selectAll("path")
       .data(data[0].features)
       
       map.enter()
       .append("path")
       .merge(map)
       .attr( "d", path )
              
       .attr("fill", function(d){ 
         if (selectedRegion.localeCompare("illinois") === 0) {
            // console.log('hi')
            return Colors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region])
         } else {
             if (countyMap[d.properties.COUNTY_NAM].covid_region === parseInt(selectedRegion.split('_')[1])) {
                   return Colors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
            } else {
                     return "#7E7E7E" 
            }
         }
      })
      .attr("stroke", function(d){ 
	                 
           if (selectedRegion.localeCompare("illinois") === 0) {
               return mapFillColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region])
            } else {
           if (
             countyMap[d.properties.COUNTY_NAM].covid_region ===
             parseInt(selectedRegion.split('_')[1])) {
                   return mapFillColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
            } else {
               return "#AAAAAA" 
            }
         }
      }) 
      
   map.exit()
    .remove()
 

   var dataFilter = data[1].filter(function(d){return d.geography_modeled==selectedRegion}) 
           
           
        // What happens when the mouse move -> show the annotations at the right positions.
  function mouseover() {
    focus.style("opacity", 1)
    focusText.style("opacity",1)
  }

  function mousemove() {
    // recover coordinate we need
    var formatTime = d3.timeFormat("%B %d")
    var x0 = x_rt.invert(d3.mouse(this)[0]);
    var i = bisect(dataFilter, x0, 1);
    var selectedData = dataFilter[i]
    console.log(selectedData)
    focus
      .attr("cx", x_rt(selectedData.date))
      .attr("cy", y_rt(selectedData.rt_median))
    focusText
      .html("<br>" + formatTime(selectedData.date) + "  " + "Rt:" +  parseFloat((selectedData.rt_median)).toFixed(2))
      .attr("x", x_rt(selectedData.date ))
      .attr("y", y_rt(selectedData.rt_median))
    }
  function mouseout() {
    focus.style("opacity", 0)
    focusText.style("opacity", 0)
  }
  
  
    x_rt.domain(d3.extent(data[1] , function(d) { return d.date}))
                  
   //y_rt.domain([0, d3.max(data.filter(function(d){return d.geography_modeled==allGroup[0]}), function(d) { return d.rt_upper })])
   
   y_rt.domain([0, 2]);
        
   y_rt_axis.attr("class", "y axis")
    .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  );

   interval_rt.datum(dataFilter)
                      .attr("fill", function(d){ return lightestColors(selectedRegion) })
                      .attr("stroke", "none")
                      .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  ); 

    
   line_rt.datum(dataFilter)
                  .attr("stroke", function(d){ return Colors(selectedRegion) })
                  .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  )
                  .style("stroke-width", 2)
                  .style("fill", "none")

   refLine.datum(dataFilter)
                  .attr("stroke", "black")
                  .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  )
                  .style("stroke-width", 1)
                  .style("stroke-dasharray", ("3, 3"))
                  .style("fill", "none")              

      
      var currentWidth = document.getElementById("rt_chart").offsetWidth;
      
      const width_rt = currentWidth- margin_rt.left - margin_rt.right;
      let height_rt = parseInt(currentWidth * 0.35 ) - margin_rt.top - margin_rt.bottom;

      if (parseInt(currentWidth) < 600) {
         height_rt = parseInt(currentWidth * .72) - margin_rt.top - margin_rt.bottom;
         // console.log("hi")
      }
      else if (parseInt(currentWidth) < 900) {
         height_rt = parseInt(currentWidth * .62) - margin_rt.top - margin_rt.bottom;
      }

      
      svg_rt.attr("width", width_rt + margin_rt.left + margin_rt.right)
      .attr("height", height_rt + margin_rt.top + margin_rt.bottom)
      .append("g")
    .attr("transform",
          "translate(" + margin_rt.left + "," + margin_rt.top + ")");
      
      xTitle.attr("transform", "translate(" + (currentWidth/2) + " ," + (height_rt +30)+ ")")
      yTitle.attr("x",0 - (height_rt / 2))
      
      x_rt.range([ 0, width_rt ]);
      x_rt_axis.attr("transform", "translate(" + margin_rt.left + "," + (margin_rt.top + height_rt) + ")")
      // .call(d3.axisBottom(x_rt).ticks(5));
      if (currentWidth < 600) {
         x_rt_axis.call(d3.axisBottom(x_rt).ticks(3));
         // x_rt_axis.call(d3.axisBottom(x_rt).ticks(d3.timeMonths, 1).tickFormat(d3.timeFormat("%b")));
         
      }else {
         x_rt_axis.call(d3.axisBottom(x_rt).ticks(6));
      }
           
      y_rt.range([ height_rt, 0 ])
      y_rt_axis.call(d3.axisLeft(y_rt).ticks(6));
      
      

      
      interval_rt
            .transition()
      .duration(1000)
      .attr("d", d3.area()
      .x(function(d) { return x_rt(d.date) })
      .y0(function(d) { return y_rt(d.rt_lower) })
      .y1(function(d) { return y_rt(d.rt_upper) }))
      
      line_rt
            .transition()
      .duration(1000)
      .attr("d", d3.line()
      .x(function(d) { return x_rt(d.date) })
      .y(function(d) { return y_rt(d.rt_median) })
      )
      
      refLine
            .transition()
      .duration(1000)
       .attr("d", d3.line()
       .x(function(d) { return x_rt(d.date) })
       .y(function(d) { return y_rt(1.0) }));
      
        svg_rt
    .append('rect')
    .style("fill", "none")
    .style("pointer-events", "all")
    .attr('width', width_rt)
    .attr('height', height_rt)
    .on('mouseover', mouseover)
    .on('mousemove', mousemove)
    .on('mouseout', mouseout);


      
      currentWidth = document.getElementById("cases_chart").offsetWidth;
      const width_cases = currentWidth- margin_cases.left - margin_cases.right;
      let height_cases = parseInt(currentWidth * 0.35 ) - margin_cases.top - margin_cases.bottom;
      
      
            
      if (parseInt(currentWidth) < 600) {
         height_cases = parseInt(currentWidth * .72) - margin_cases.top - margin_cases.bottom;
      }
      else if (parseInt(currentWidth) < 900) {
         height_cases = parseInt(currentWidth * .62) - margin_cases.top - margin_cases.bottom;
      }
      
      
      // svg_cases.attr("width", width_cases + margin_cases.left + margin_cases.right)
      //          .attr("height", height_cases + margin_cases.top + margin_cases.bottom)

      let dict = {};
      dict["illinois"] = "Illinois";
      dict["covidregion_1"] = "Central";
      dict["covidregion_2"] = "Chicago";
      dict["covidregion_3"] = "Collar";
      dict["covidregion_4"] = "West Central";
      dict["covidregion_5"] = "North Central";
      dict["covidregion_6"] = "Northern";
      dict["covidregion_7"] = "Northwest";
      dict["covidregion_8"] = "Southeast Central";
      dict["covidregion_9"] = "Southern";
      dict["covidregion_10"] = "Southwest Central";
      dict["covidregion_11"] = "Suburban";
   
        
   var selectedGroupCases = dict[selectedRegion]
   
   
   svg_cases
    .attr("width", width_cases + margin_cases.left + margin_cases.right)
    .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
  .append("g")
  
    .attr("transform",
          "translate(" + margin_cases.left + "," + margin_cases.top + ")");
   
   
   var data_map = data[2].filter(function(d){return d.NOFO_Region==selectedGroupCases})
   
const formatTime = d3.timeFormat("%b. %Y");
  const len = data.length - 1;

  x_cases.domain(data_map.map(function(d) { return d.update_date; }))
  .range([0,width_cases])
  .padding(0);
  

//  x_axis.attr("transform", "translate(0," + height + ")")
 x_axis
 .attr("transform", "translate(" + margin_cases.left + "," + (height_cases+margin_cases.top) + ")")
  .call(d3.axisBottom(x_cases)
  .tickValues(x_cases.domain().filter(function(d,i){ return !(i%30)}))
   //  .tickValues(tickValuesForAxis)
    .tickFormat((d, i) => {
      var r = '';
      var dt = d; //console.log(d)
      if ((i%30) || i == len) r = formatTime(dt);
      return r;
       })
    );

  y_cases
  .domain([0, d3.max(data_map, function(d) { return d.new_cases; })])
  .range([height_cases, 0]);
// var y_axis = svg.append("g")
 y_axis.attr("transform", "translate("+ (margin_cases.left-2) +","+ margin_cases.top  + ")"  ).call(d3.axisLeft(y_cases));

  // Create the u variable
  var u = svg_cases.selectAll("rect")
    .data(data_map)

  u
    .enter()
    .append("rect") // Add a new rect for each new elements
    .merge(u) // get the already existing elements as well
    .transition() // and apply changes to all of them
    
    .duration(1000)
    
      .attr("x", function(d) { return x_cases(d.update_date); })
      .attr("y", function(d) { return y_cases(d.new_cases); })
      .attr("width", x_cases.bandwidth())
      // .attr("height", function(d) { return height - y(d.new_cases); })
      .attr("height", function(d) { return height_cases - y_cases(d.new_cases); })
      
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      // .attr("transform", "translate(" + margin.left + "," + height + ")")

  // If less group in the new dataset, I delete the ones not in use anymore
  u
    .exit()
    .remove()
    
   // u
   svg_cases.selectAll("rect").attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );
    
  const POINTS_AVERAGE = 6;
 var line = d3
    .line()
    .x(d => x_cases(d.update_date))
    .y((d, i, data_map) => {
      var r,
        avg = 0;
      for (let j = 0; j <= POINTS_AVERAGE; j++) {
        if (i - j >= 0) {
          avg += y_cases(data_map[i - j].new_cases);
          r = Math.floor(avg / (j + 1));
        } else {
          r = Math.floor(avg / j);
          j = POINTS_AVERAGE + 1;
        }
      }
    //   console.log(i, r, y(d.count));
      return r;
    });

svg_cases.selectAll('path').remove();
  
  svg_cases
    .append('path')
    .datum(data_map)
    .attr('fill', 'none')
   //  .attr('stroke', '#000000')
   .attr("stroke", function(d){ return Colors(selectedRegion) })
    .attr('stroke-width', 2.5)
    .attr('stroke-linejoin', 'round')
    .attr('stroke-linecap', 'round')
    .attr('d', line).attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  );

   
   svg_deaths
    .attr("width", width_cases + margin_cases.left + margin_cases.right)
    .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
  .append("g")
  
    .attr("transform",
          "translate(" + margin_cases.left + "," + margin_cases.top + ")");
   
   
//    var data_map = data[2].filter(function(d){return d.NOFO_Region==selectedGroupCases})
   
// const formatTime = d3.timeFormat("%b. %Y");
//  const len = data.length - 1;

  x_deaths.domain(data_map.map(function(d) { return d.update_date; }))
  .range([0,width_cases])
  .padding(0);
  

//  x_axis.attr("transform", "translate(0," + height + ")")
 x_axis_deaths
 .attr("transform", "translate(" + margin_cases.left + "," + (height_cases+margin_cases.top) + ")")
  .call(d3.axisBottom(x_deaths)
  .tickValues(x_deaths.domain().filter(function(d,i){ return !(i%30)}))
   //  .tickValues(tickValuesForAxis)
    .tickFormat((d, i) => {
      var r = '';
      var dt = d; //console.log(d)
      if ((i%30) || i == len) r = formatTime(dt);
      return r;
       })
    );

  y_deaths
  .domain([0, d3.max(data_map, function(d) { return d.new_deaths; })])
  .range([height_cases, 0]);
// var y_axis = svg.append("g")
 y_axis_deaths.attr("transform", "translate("+ (margin_cases.left-2) +","+ margin_cases.top  + ")"  ).call(d3.axisLeft(y_deaths));

  // Create the u variable
  var i = svg_deaths.selectAll("rect")
    .data(data_map)

  i
    .enter()
    .append("rect") // Add a new rect for each new elements
    .merge(i) // get the already existing elements as well
    .transition() // and apply changes to all of them
    
    .duration(1000)
    
      .attr("x", function(d) { return x_deaths(d.update_date); })
      .attr("y", function(d) { return y_deaths(d.new_deaths); })
      .attr("width", x_deaths.bandwidth())
      // .attr("height", function(d) { return height - y(d.new_cases); })
      .attr("height", function(d) { return height_cases - y_deaths(d.new_deaths); })
      
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      // .attr("transform", "translate(" + margin.left + "," + height + ")")

  // If less group in the new dataset, I delete the ones not in use anymore
  i
    .exit()
    .remove()
    
   // u
   svg_deaths.selectAll("rect").attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );
    
//  const POINTS_AVERAGE = 6;
 var lineA = d3
    .line()
    .x(d => x_deaths(d.update_date))
    .y((d, i, data_map) => {
      var r,
        avg = 0;
      for (let j = 0; j <= POINTS_AVERAGE; j++) {
        if (i - j >= 0) {
          avg += y_deaths(data_map[i - j].new_deaths);
          r = Math.floor(avg / (j + 1));
        } else {
          r = Math.floor(avg / j);
          j = POINTS_AVERAGE + 1;
        }
      }
    //   console.log(i, r, y(d.count));
      return r;
    });

svg_deaths.selectAll('path').remove();
  
  svg_deaths
    .append('path')
    .datum(data_map)
    .attr('fill', 'none')
   //  .attr('stroke', '#000000')
    .attr("stroke", function(d){ return Colors(selectedRegion) })
    .attr('stroke-width', 2.5)
    .attr('stroke-linejoin', 'round')
    .attr('stroke-linecap', 'round')
    .attr('d', lineA).attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  );
    

    }
    // Initialize the chart
    drawChart();
    // console.log("done")
    // Add an event listener that run the function when dimension change
    window.addEventListener('resize', drawChart ); 
    // console.log("hi")
          // When the button is changed, run the updateChart funso ction
    d3.select("#selectButton").on("change", function(d) {
      // recover the option that has been chosen
      // var selectedOption = d3.select(this).property("value")
       selectedRegion = d3.select(this).property("value")
      // run the updateChart function with this selected option
      // console.log(selectedOption)
      drawChart()

    })

    
}); //Promise.all    




</script>