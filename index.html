---
layout: default
title: Home
---
<style>
    .jumbotron {
    background-color:transparent !important;
    }
    .chart {
        z-index: 1;
        margin-bottom: 20px;
        
    }
    body {
        padding-top: 50px;
}
	.classy {
      fill:#009DAA;
    } 
 
   #cases_map {
      /*z-index: 2;*/
      position: fixed;
      z-index: 2;
   }
   .card-body {
      /*width: 100%;*/
      margin-right: 20px;
   }
   
   .subtitle {
      margin-bottom: 20px;
   }
@media only screen and (max-width: 339px) {
      body {
         padding-top: 100px;
      }
      #cases_map {
         width: 20%;
         /*margin-top: 30px*/
         /*border: solid red 1px;*/
      }
      .rt {
         width: 80%;
         float: right;
      }
      .cases {
         width: 80%;
         float: right;
      }
      .deaths {
         width: 80%;
         float: right;
      }
}


@media only screen and (min-width: 339px) {
      body {
         padding-top: 75px;
         margin-right: 0%;
      }
      #cases_map {
         width: 20%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 80%;
         float: right;
      }
      .cases {
         width: 80%;
         float: right;
      }
      .deaths {
         width: 80%;
         float: right;
      }

}

/* Small devices (portrait tablets and large phones, 600px and up) */
@media only screen and (min-width: 600px) {
      #cases_map {
         width: 18%;
      }
      body {
         padding-top: 70px;
      }
      #cases_map {
         width: 15%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 85%;
         float: right;
         margin-right: 0%;
      }
      .cases {
         width: 85%;
         float: right;
      }
      .deaths {
         width: 85%;
         float: right;
      }
      
}

/* Medium devices (landscape tablets, 768px and up) */
@media only screen and (min-width: 768px) {
      
      #cases_map {
         width: 15%;
      }
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Large devices (laptops/desktops, 992px and up) */
@media only screen and (min-width: 992px) {
   body{
      /*margin-left: 5%;*/
      margin-right: 5%;
   }
   #cases_map {
         width: 13%;
      }
}

/* Extra large devices (large laptops and desktops, 1200px and up) */
@media only screen and (min-width: 1200px) {
   
      body{
      /*margin-left: 5%;*/
      margin-right: 10%;
   }
   #cases_map {
         width: 10%;
      }
}
	.selected {
	  
	  fill: #20487c;
	  
	}
</style>

<div class="map" id = "cases_map"></div>


<div class="card rt " id = "">
  <div class="card-body">
    <h2>Transmission Status</h2>
    <text>Subtitle for rt chart: we believe 
    the rt level is at this level and the text blah </text>
  </div>
</div>

<div class = "card rt chart">
   <div class="card-body" id = "rt_chart"> </div>
</div>


<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases</h2>
    <text>Subtitle for cases chart </text>
  </div>
</div>

<div class = "card cases chart">
   <div class="card-body" id = "cases_chart"> </div>
</div>


<div class="card deaths " id = "">
  <div class="card-body">
    <h2>Deaths</h2>
    <text>Subtitle for deaths chart </text>
  </div>
</div>

<div class = "card deaths chart">
   <div class="card-body" id = "deaths_chart"> </div>
</div>


<script>
   /* global d3 */
   /* global $ */
   
   /*
   init all chart variables
   manual first draw charts with Illinois
   draw charts updates data 
   
   
   drawCharts (on resize)
    - get div widths 
    - set div heights dep on wid
   updateCharts (on dropdown)
   
   
   
   */
   
   
   //
   
   
   function LightenDarkenColor(col,amt) {
      var usePound = false;
      if ( col[0] == "#" ) {
         col = col.slice(1);
         usePound = true;
      }
      var num = parseInt(col,16);
      
      var r = (num >> 16) + amt;
      if ( r > 255 ) r = 255;
      else if  (r < 0) r = 0;
      
      var b = ((num >> 8) & 0x00FF) + amt;
      if ( b > 255 ) b = 255;
      else if  (b < 0) b = 0;
      
      var g = (num & 0x0000FF) + amt;
      if ( g > 255 ) g = 255;
      else if  ( g < 0 ) g = 0;
      
      return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
   }
   
  
   var hexColors = ["#BA3E39", "#BA7FB7","#89D0C5", "#F9B554", "#969696", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#DCC29C"]
   var hexColorsLight = ["#BA3E39", "#BA7FB7","#89D0C5", "#F9B554", "#969696", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#DCC29C"]
   
   
   var i;
   for (i = 0; i < hexColorsLight.length; i++) {
      hexColorsLight[i] = LightenDarkenColor(hexColorsLight[i], -30)
   }
   
   let allGroup = ["illinois", "covidregion_1", "covidregion_2", "covidregion_3", 
                   "covidregion_4", "covidregion_5", "covidregion_6", "covidregion_7", 
                   "covidregion_8", "covidregion_9", "covidregion_10", "covidregion_11"]

     d3.select("#selectButton")
    .selectAll('myOptions')
    .data(allGroup)
    .enter()
    .append('option')
    .text(function (d) { 
                         if(d == "illinois" ||d == "Illinois" ) {
                              return "Illinois";
                          }
                          d = "Region " + d.substring( d.indexOf('_')+1);
                          return d; 
                        })
    .attr("value", function (d) { return d; })
    .attr("class", "dropdown-item")
    
   var myColor = d3.scaleOrdinal().domain(allGroup)
     .range(hexColors)
   var lightColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLight)
   
   var countyMap = {
      "ADAMS": {
         "covid_region": 3
      },
      "ALEXANDER": {
         "covid_region": 5
      },
      "BOND": {
         "covid_region": 4
      },
      "BOONE": {
         "covid_region": 1
      },
      "BROWN": {
         "covid_region": 3
      },
      "BUREAU": {
         "covid_region": 2
      },
      "CALHOUN": {
         "covid_region": 3
      },
      "CARROLL": {
         "covid_region": 1
      },
      "CASS": {
         "covid_region": 3
      },
      "CHAMPAIGN": {
         "covid_region": 6
      },
      "CHICAGO": {
         "covid_region": 11
      },
      "CHRISTIAN": {
         "covid_region": 3
      },
      "CLARK": {
         "covid_region": 6
      },
      "CLAY": {
         "covid_region": 6
      },
      "CLINTON": {
         "covid_region": 4
      },
      "COLES": {
         "covid_region": 6
      },
      "COOK": {
         "covid_region": 10
      },
      "CRAWFORD": {
         "covid_region": 6
      },
      "CUMBERLAND": {
         "covid_region": 6
      },
      "DE WITT": {
         "covid_region": 6
      },
      "DEKALB": {
         "covid_region": 1
      },
      "DOUGLAS": {
         "covid_region": 6
      },
      "DUPAGE": {
         "covid_region": 8
      },
      "EDGAR": {
         "covid_region": 6
      },
      "EDWARDS": {
         "covid_region": 5
      },
      "EFFINGHAM": {
         "covid_region": 6
      },
      "FAYETTE": {
         "covid_region": 6
      },
      "FORD": {
         "covid_region": 6
      },
      "FRANKLIN": {
         "covid_region": 5
      },
      "FULTON": {
         "covid_region": 2
      },
      "GALLATIN": {
         "covid_region": 5
      },
      "GREENE": {
         "covid_region": 3
      },
      "GRUNDY": {
         "covid_region": 2
      },
      "HAMILTON": {
         "covid_region": 5
      },
      "HANCOCK": {
         "covid_region": 3
      },
      "HARDIN": {
         "covid_region": 5
      },
      "HENDERSON": {
         "covid_region": 2
      },
      "HENRY": {
         "covid_region": 2
      },
      "IROQUOIS": {
         "covid_region": 6
      },
      "JACKSON": {
         "covid_region": 5
      },
      "JASPER": {
         "covid_region": 6
      },
      "JEFFERSON": {
         "covid_region": 5
      },
      "JERSEY": {
         "covid_region": 3
      },
      "JO DAVIESS": {
         "covid_region": 1
      },
      "JOHNSON": {
         "covid_region": 5
      },
      "KANE": {
         "covid_region": 8
      },
      "KANKAKEE": {
         "covid_region": 7
      },
      "KENDALL": {
         "covid_region": 2
      },
      "KNOX": {
         "covid_region": 2
      },
      "LAKE": {
         "covid_region": 9
      },
      "LASALLE": {
         "covid_region": 2
      },
      "LAWRENCE": {
         "covid_region": 6
      },
      "LEE": {
         "covid_region": 1
      },
      "LIVINGSTON": {
         "covid_region": 2
      },
      "LOGAN": {
         "covid_region": 3
      },
      "MACON": {
         "covid_region": 6
      },
      "MACOUPIN": {
         "covid_region": 3
      },
      "MADISON": {
         "covid_region": 4
      },
      "MARION": {
         "covid_region": 5
      },
      "MARSHALL": {
         "covid_region": 2
      },
      "MASON": {
         "covid_region": 3
      },
      "MASSAC": {
         "covid_region": 5
      },
      "MCDONOUGH": {
         "covid_region": 2
      },
      "MCHENRY": {
         "covid_region": 9
      },
      "MCLEAN": {
         "covid_region": 2
      },
      "MENARD": {
         "covid_region": 3
      },
      "MERCER": {
         "covid_region": 2
      },
      "MONROE": {
         "covid_region": 4
      },
      "MONTGOMERY": {
         "covid_region": 3
      },
      "MORGAN": {
         "covid_region": 3
      },
      "MOULTRIE": {
         "covid_region": 6
      },
      "OGLE": {
         "covid_region": 1
      },
      "PEORIA": {
         "covid_region": 2
      },
      "PERRY": {
         "covid_region": 5
      },
      "PIATT": {
         "covid_region": 6
      },
      "PIKE": {
         "covid_region": 3
      },
      "POPE": {
         "covid_region": 5
      },
      "PULASKI": {
         "covid_region": 5
      },
      "PUTNAM": {
         "covid_region": 2
      },
      "RANDOLPH": {
         "covid_region": 4
      },
      "RICHLAND": {
         "covid_region": 6
      },
      "ROCK ISLAND": {
         "covid_region": 2
      },
      "SALINE": {
         "covid_region": 5
      },
      "SANGAMON": {
         "covid_region": 3
      },
      "SCHUYLER": {
         "covid_region": 3
      },
      "SCOTT": {
         "covid_region": 3
      },
      "SHELBY": {
         "covid_region": 6
      },
      "ST. CLAIR": {
         "covid_region": 4
      },
      "STARK": {
         "covid_region": 2
      },
      "STEPHENSON": {
         "covid_region": 1
      },
      "TAZEWELL": {
         "covid_region": 2
      },
      "UNION": {
         "covid_region": 5
      },
      "VERMILION": {
         "covid_region": 6
      },
      "WABASH": {
         "covid_region": 5
      },
      "WARREN": {
         "covid_region": 2
      },
      "WASHINGTON": {
         "covid_region": 4
      },
      "WAYNE": {
         "covid_region": 5
      },
      "WHITE": {
         "covid_region": 5
      },
      "WHITESIDE": {
         "covid_region": 1
      },
      "WILL": {
         "covid_region": 7
      },
      "WILLIAMSON": {
         "covid_region": 5
      },
      "WINNEBAGO": {
         "covid_region": 1
      },
      "WOODFORD": {
         "covid_region": 2
      }
   }

	var map_wid = document.getElementById("cases_map").offsetWidth;
	var map_hid = map_wid *2;
	
	var margin_rt = {top: 10, right: 10, bottom: 50, left: 60};
   var svg_rt = d3.select("#rt_chart").append("svg")

   var x_rt = d3.scaleTime();
   var x_rt_axis = svg_rt.append("g");
   var y_rt = d3.scaleLinear();
   var y_rt_axis = svg_rt.append("g");
   
   var interval_rt = svg_rt.append("path");
   var line_rt = svg_rt.append('g').append("path");
   var refLine = svg_rt.append('g').append("path")
   
   var dataFilter = null; 

  var margin_cases = {top: 15, right: 10, bottom: 50, left: 60};
  var margin_deaths = {top: 15, right: 10, bottom: 50, left: 60};
  
  var svg_cases = d3.select("#cases_chart").append("svg")
  var svg_deaths = d3.select("#deaths_chart").append("svg")
              
    var x_cases = d3.scaleTime();
    var x_cases_axis = svg_cases.append("g")
    var y_cases = d3.scaleLinear()
    var y_cases_axis = svg_cases.append("g")
    var area_cases = svg_cases.append("path")
    
    var x_deaths = d3.scaleTime()
    var x_deaths_axis = svg_deaths.append("g")
    var y_deaths = d3.scaleLinear()
    var y_deaths_axis = svg_deaths.append("g")
    var area_deaths = svg_deaths.append("path")


	var svg = d3.select("#cases_map")
	            .append("svg")
	            .attr("width", map_wid )
	            .attr("height", map_hid)
	            .attr("id", "svg_id")
	            .append("g").attr("id", "group");
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	d3.select(window)
    		.on("resize", sizeChange);
   
   		var projection = d3.geoAlbers()
   		var path = d3.geoPath()
	d3.json('https://raw.githubusercontent.com/samhovie/sitefiles/main/il-counties.json').then(function(data) {
	   
   projection.rotate([89.5,0]).fitSize([map_wid, map_hid], data);

// 	var path = d3.geoPath()
	             path.projection(projection);
	   
	   
	   svg.selectAll("path")
	      .data(data.features)
	      .enter().append("path")
	      //initial fill function
	      .attr("fill", function(d){ 
	         return lightColors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
	      })
	      .attr("stroke", function(d){ 
	         return myColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
	      })
	     // .attr("stroke-width", "3px")
	      .attr("class", "")
	      .attr("d", path);
	});
	
	
	
	function sizeChange() {
	   d3.select("#group")
	     .attr("transform", "scale(" + $("#cases_map").width()/150 + ")");
	   
	  // $("#svg_id").width($("#cases_map"))
	   $("#svg_id").height($("#cases_map").width()*2)
	}
  
  

    

  

  d3.csv('https://raw.githubusercontent.com/samhovie/sitefiles/main/nu_20201027.csv').then(function(data) {
    let parseDate = d3.timeParse("%Y-%m-%d");
    let today = new Date();
    data = data.filter(function(d){
      if(isNaN(d.rt_median) || 
          d.scenario_name !== 'baseline' ||
          parseDate(d.date) > today  
          ){
        return false;
      }
      d.rt_lower = +d.rt_lower;
      d.rt_median = +d.rt_median;
      d.rt_upper = +d.rt_upper;
      d.date = parseDate(d.date);
      return true;
    });
            

    x_rt.domain(d3.extent(data, function(d) { return d.date}))
                  
    y_rt.domain([0, d3.max(data.filter(function(d){return d.geography_modeled==allGroup[0]}), function(d) { return d.rt_upper })])
        
    y_rt_axis.attr("class", "y axis")
    .attr("transform", "translate("+ margin_rt.left +","+ 0  + ")"  )

    interval_rt.datum(data.filter(function(d){return d.geography_modeled==allGroup[0]}))
                      .attr("fill", function(d){ return lightColors(allGroup[0]) })
                      .attr("stroke", "none")
                      .attr("transform", "translate(" +(margin_rt.left+1)+" ,0)")  

    
    line_rt.datum(data.filter(function(d){return d.geography_modeled==allGroup[0]}))
                  .attr("stroke", function(d){ return myColor(allGroup[0]) })
                  .attr("transform", "translate(" +(margin_rt.left+1)+" ,0)") 
                  .style("stroke-width", 2)
                  .style("fill", "none")
                  
                  
                  
   refLine.datum(data.filter(function(d){return d.geography_modeled==allGroup[0]}))
                  .attr("stroke", "black")
                  .attr("transform", "translate(" +(margin_rt.left+1)+" ,0)") 
                  .style("stroke-width", 1)
                  .style("stroke-dasharray", ("3, 3"))
                  .style("fill", "none")              
                  
    var xTitle = svg_rt.append("text")
      .style("text-anchor", "middle")
      .text("");
      
    var yTitle = svg_rt.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      // .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Rt");     
      
      
        // This allows to find the closest X index of the mouse:
  var bisect = d3.bisector(function(d) { return d.date; }).left;

  // Create the circle that travels along the curve of chart
  var focus = svg_rt
    .append('g')
    .append('circle')
      .style("fill", "none")
      .attr("stroke", "black")
      .attr('r', 4.5)
      .style("opacity", 0)
      .attr("transform", "translate("+ margin_rt.left +","+ 0  + ")"  ); 

  // Create the text that travels along the curve of chart
  var focusText = svg_rt
    .append('g')
    .append('text')
      .style("opacity", 0)
      .attr("text-anchor", "left")
      .attr("alignment-baseline", "middle")
      .attr("transform", "translate("+ margin_rt.left +","+ 0  + ")"  ); 
      
   function mouseover() {
    focus.style("opacity", 1)
    focusText.style("opacity",1)
  }

  function mousemove() {
    data = data.filter(function(d){return d.geography_modeled==allGroup[0]})
    var formatTime = d3.timeFormat("%B %d")
    // recover coordinate we need
    // console.log(d3.mouse(this)[0])
    var x0 = x_rt.invert(d3.mouse(this)[0]);
    // console.log(x0);
    var i = bisect(data, x0, 1);
    // console.log(i)
    
    var selectedData = data[i]
    focus
      .attr("cx", x_rt(selectedData.date))
      .attr("cy", y_rt(selectedData.rt_median))
    focusText
      .html("<br>" + formatTime(selectedData.date) + "  " + "Rt:" + (selectedData.rt_median).toFixed(4))
      .attr("x", x_rt(selectedData.date ))
      .attr("y", y_rt(selectedData.rt_median))
    }
  function mouseout() {
    focus.style("opacity", 0)
    focusText.style("opacity", 0)
  }

    
    // A function that finishes to draw the chart for a specific device size.
    function drawChart() {
      
      const currentWidth = document.getElementById("rt_chart").offsetWidth;
      
      const width = currentWidth- margin_rt.left - margin_rt.right;
      const height = parseInt(currentWidth * 0.62 ) - margin_rt.top - margin_rt.bottom;
      // console.log(currentWidth)
      
      svg_rt.attr("width", width + margin_rt.left + margin_rt.right)
      .attr("height", height + margin_rt.top + margin_rt.bottom)
      .append("g")
    .attr("transform",
          "translate(" + margin_rt.left + "," + margin_rt.top + ")");
      
      xTitle.attr("transform", "translate(" + (currentWidth/2) + " ," + (height +30)+ ")")
      yTitle.attr("x",0 - (height / 2))
      
      x_rt.range([ 0, width ]);
      x_rt_axis.attr("transform", "translate(" + margin_rt.left + "," + height + ")")
      // .call(d3.axisBottom(x_rt).ticks(5));
      if (currentWidth < 600) {
         x_rt_axis.call(d3.axisBottom(x_rt).ticks(3));
      }else {
         x_rt_axis.call(d3.axisBottom(x_rt).ticks(6));
      }
           
      y_rt.range([ height, 0 ])
      y_rt_axis.call(d3.axisLeft(y_rt).ticks(6));
      

      
      interval_rt
      .attr("d", d3.area()
      .x(function(d) { return x_rt(d.date) })
      .y0(function(d) { return y_rt(d.rt_lower) })
      .y1(function(d) { return y_rt(d.rt_upper) }))
      
      line_rt
      .attr("d", d3.line()
      .x(function(d) { return x_rt(d.date) })
      .y(function(d) { return y_rt(d.rt_median) })
      )
      
      refLine
       .attr("d", d3.line()
       .x(function(d) { return x_rt(d.date) })
       .y(function(d) { return y_rt(1.0) }));
      
      svg_rt
       .append('rect')
       .style("fill", "none")
       .style("pointer-events", "all")
       .attr('width', width)
       .attr('height', height)
       .on('mouseover', mouseover)
       .on('mousemove', mousemove)
       .on('mouseout', mouseout)
       .attr("transform", "translate("+ margin_rt.left +","+ 0  + ")"  ); 
        


    }
    // Initialize the chart
    drawChart();
    // console.log("done")
    // Add an event listener that run the function when dimension change
    window.addEventListener('resize', drawChart ); 
    // console.log("hi")
    
});

    
    
// d3.csv('https://docs.google.com/spreadsheets/d/1MWNebArAjjTTtJdxQcnUakShSbADhccx3xw28L2Nflo/gviz/tq?tqx=out:csv&sheet=NOFO_long').then(function(data) {
 d3.csv('https://raw.githubusercontent.com/samhovie/sitefiles/main/NOFO_long.csv').then(function(data) {
//  var first_iteration = true;
  var prev_cases = 0;
  var prev_region = "";
  var prev_deaths = 0;
  var cases_max_diff = {};
  var deaths_max_diff = {};
  let parseDate = d3.timeParse("%Y-%m-%d");

  data.forEach((d) => {
    d.update_date = (d.update_date).substr(0,(d.update_date).indexOf(' '))
    d.update_date = parseDate(d.update_date);
    d.Positive_Cases = +d.Positive_Cases
    d.Tested = +d.Tested
    d.Deaths = +d.Deaths;
    d.new_cases = 0;
    d.new_deaths = 0;
    
    if ((prev_region.localeCompare(d.NOFO_Region)) !== 0) {
      //  console.log(d.NOFO_Region)
       cases_max_diff[d.NOFO_Region] = 0;
       deaths_max_diff[d.NOFO_Region] = 0;
       
       prev_cases = d.Positive_Cases;
       d.new_cases = d.Positive_Cases;
       
      prev_deaths = d.Deaths;
      d.new_deaths = d.Deaths;
      prev_region = d.NOFO_Region;
    } else {
      if (d.Positive_Cases < prev_cases) {
         d.new_cases = 0;
      } else {
         d.new_cases = d.Positive_Cases - prev_cases;
      }
      
      if (d.Deaths < prev_deaths) {
         d.new_deaths = 0;
         
      } else {
         d.new_deaths = d.Deaths - prev_deaths;
         
      }
      
      if( d.new_cases > cases_max_diff[d.NOFO_Region] ) {
         cases_max_diff[d.NOFO_Region] = d.new_cases;
         // console.log(d.update_date)
         
      } 
      
      if( d.new_deaths > deaths_max_diff[d.NOFO_Region] ) {
         deaths_max_diff[d.NOFO_Region] = d.new_deaths;
      } 
       
       prev_cases = d.Positive_Cases;
       prev_deaths = d.Deaths;
       prev_region = d.NOFO_Region;
    }

    
  });

  data = data.filter(function(d){return d.NOFO_Region=="Illinois"})
  
//  console.log(data)

      x_cases.domain(d3.extent(data, function(d) { return d.update_date; }))

      // y_cases.domain([0, d3.max(data, function(d) { return d.Positive_Cases; })])
      y_cases.domain([0, d3.max(data, function(d) { return d.new_cases; })])
      
    y_cases_axis.attr("class", "y axis")
    .attr("transform", "translate("+ margin_cases.left +",0)")
      .call(d3.axisLeft(y_cases));

      area_cases.datum(data)
      .attr("fill", function(d){ return lightColors(allGroup[0]) })
      .attr("stroke", function(d){ return myColor(allGroup[0]) })
      .attr("stroke-width", 2)
      .attr("transform", "translate(2,-1)").attr("transform", "translate(" +(margin_cases.left+1)+" ,0)");
      
      x_deaths.domain(d3.extent(data, function(d) { return d.update_date; }))
      // y_deaths.domain([0, d3.max(data, function(d) { return d.Deaths; })]) // Changed to the largest difference - save when reading in? 
      y_deaths.domain([0, d3.max(data, function(d) { return d.new_deaths; })])
      
    y_deaths_axis.attr("class", "y axis")
    .attr("transform", "translate("+ margin_deaths.left +",0)")
      .call(d3.axisLeft(y_deaths));

      area_deaths.datum(data)
      // .attr("fill", "#cce5df")
      .attr("fill", function(d){ return lightColors(allGroup[0]) })
      .attr("stroke", function(d){ return myColor(allGroup[0]) })
      .attr("stroke-width", 2)
      .attr("transform", "translate(2,-1)").attr("transform", "translate(" +(margin_deaths.left+1)+" ,0)");  
      
    function drawChart() {
      
      const currentWidth = document.getElementById("cases_chart").offsetWidth;
      const width_cases = currentWidth- margin_cases.left - margin_cases.right;
      const height_cases = parseInt(currentWidth * 0.45 ) - margin_cases.top - margin_cases.bottom;
      
      svg_cases.attr("width", width_cases + margin_cases.left + margin_cases.right)
               .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
      
      
      x_cases.range([ 0, width_cases ]);
      x_cases_axis.attr("transform", "translate(" + margin_rt.left + "," + height_cases + ")")
      // .call(d3.axisBottom(x_cases).ticks(5));
      
      if (currentWidth < 600) {
         x_cases_axis.call(d3.axisBottom(x_cases).ticks(3));
      }else {
         x_cases_axis.call(d3.axisBottom(x_cases).ticks(6));
      }
      
      y_cases.range([ height_cases, 0 ])
      y_cases_axis.call(d3.axisLeft(y_cases).ticks(6));
      
      area_cases
      .attr("d", d3.area()
      .x(function(d) { return x_cases(d.update_date) })
      .y0(y_cases(0))
      .y1(function(d) { return y_cases(d.new_cases) })
      )
      
      
      const width_deaths = currentWidth- margin_deaths.left - margin_deaths.right;
      const height_deaths = parseInt(currentWidth * 0.45 ) - margin_deaths.top - margin_deaths.bottom;
      
      
      svg_deaths.attr("width", width_deaths + margin_cases.left + margin_cases.right)
      svg_deaths.attr("height", height_deaths + margin_cases.top + margin_cases.bottom)
      
      
      x_deaths.range([ 0, width_deaths ]);
      x_deaths_axis.attr("transform", "translate(" + margin_deaths.left + "," + height_deaths + ")")
      // .call(d3.axisBottom(x_deaths).ticks(5));
      
            if (currentWidth < 600) {
         x_deaths_axis.call(d3.axisBottom(x_deaths).ticks(3));
      }else {
         x_deaths_axis.call(d3.axisBottom(x_deaths).ticks(6));
      }
      y_deaths.range([ height_deaths, 0 ])
      y_deaths_axis.call(d3.axisLeft(y_deaths).ticks(6));
      
      area_deaths
      .attr("d", d3.area()
      .x(function(d) { return x_deaths(d.update_date) })
      .y0(y_deaths(0))
      .y1(function(d) { return y_deaths(d.new_deaths) })
      )
      
      
    }
    // Initialize the chart
    drawChart();
    window.addEventListener('resize', drawChart ); 
    
    
});
    
  

    // A function that updates the chart
    function update(selectedGroup) {
       
         d3.json('https://raw.githubusercontent.com/samhovie/sitefiles/main/il-counties.json').then(function(data) {
        
             projection.rotate([89.5,0]).fitSize([map_wid, map_hid], data);

	 
	             path.projection(projection);
	     
      //  console.log(data)
            svg.append("g")
                .selectAll("path")
                .data(data.features)
                .enter()
                .append("path")
                .attr( "d", path )
                .attr("fill", function(d){ 
                   if (
                      countyMap[d.properties.COUNTY_NAM].covid_region ===
                      parseInt(selectedGroup.split('_')[1])) {
                            return myColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
                        } else {
                           return lightColors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
                        }
	         
	        // return lightColors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
	      })
	      .attr("stroke", function(d){ 
	         return myColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
	      })
               //  .attr("class", function(d){
                   
               //     if (
               //        countyMap[d.properties.COUNTY_NAM].covid_region ===
               //          parseInt(selectedGroup.split('_')[1])
               //          ) {
                            
               //              return "classy"
                        
               //     }
               //     else {
               //          return ""
               //     }
               //  })

       });    

      
//        d3.json('https://raw.githubusercontent.com/samhovie/sitefiles/main/il-counties.json').then(function(data) {
	   
	   
//     projection.rotate([89.5,0]).fitSize([map_wid, map_hid], data);

	 
// 	             path.projection(projection);
	     
	   
// 	   svg.selectAll("path")
// 	      .data(data.features)
// 	      .enter().append("path")
// 	      //initial fill function
// 	      .attr("fill", function(d){ 
// 	         return lightColors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
// 	      })
// 	      .attr("stroke", function(d){ 
// 	         return myColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
// 	      })
// 	     // .attr("stroke-width", "3px")
	     
// 	      .attr("d", path)
// 	       .attr("class", function(d){
// 	          console.log("ji")
//                    if (
//                       countyMap[d.properties.COUNTY_NAM].covid_region ===
//                         parseInt(selectedGroup.split('_')[1])
//                         ) {
                            
//                             return "classy"
                        
//                    }
//                    else {
//                         return ""
//                    }
// 	      })
// 	});
       
       
      
           
  d3.csv('https://raw.githubusercontent.com/samhovie/sitefiles/main/nu_20201027.csv').then(function(data) {
    // console.log(data);   
    // filers NaN and converts strings
    let parseDate = d3.timeParse("%Y-%m-%d");
    let today = new Date();
    data = data.filter(function(d){
      if(isNaN(d.rt_median) || 
          d.scenario_name !== 'baseline' ||
          parseDate(d.date) > today  
          ){
        return false;
      }
      d.rt_lower = +d.rt_lower;
      d.rt_median = +d.rt_median;
      d.rt_upper = +d.rt_upper;
      d.date = parseDate(d.date);
      return true;
    });
                        
      dataFilter = data.filter(function(d){return d.geography_modeled==selectedGroup})
      // dataFilter.append(data.filter(function(d){return d.geography_modeled==selectedGroup}));
      // console.log(dataFilter)
      
      y_rt.domain([0, d3.max(dataFilter, function(d) { return d.rt_upper })])
      y_rt_axis.transition()
      .duration(1000).call(d3.axisLeft(y_rt).ticks(6))
      
      
      interval_rt
      .datum(dataFilter)
      .transition()
      .duration(1000)
      .attr("fill", function(d){ return lightColors(selectedGroup) })
      .attr("stroke", "none")
      .attr("d", d3.area()
            .x(function(d) { return x_rt(d.date) })
            .y0(function(d) { return y_rt(d.rt_lower) })
            .y1(function(d) { return y_rt(d.rt_upper) })
            )
      
      // Give these new data to update line
      line_rt
      .datum(dataFilter)
      .transition()
      .duration(1000)
      .attr("d", d3.line()
            .x(function(d) { return x_rt(d.date) })
            .y(function(d) { return y_rt(d.rt_median) })
            )
            .attr("stroke", function(d){ return myColor(selectedGroup) })
    
           
      refLine
      .transition()
      .duration(1000)
        .attr("d", d3.line()
        .x(function(d) { return x_rt(d.date) })
        .y(function(d) { return y_rt(1.0) }));
      
      }); 
       
       

d3.csv('https://docs.google.com/spreadsheets/d/1MWNebArAjjTTtJdxQcnUakShSbADhccx3xw28L2Nflo/gviz/tq?tqx=out:csv&sheet=NOFO_long').then(function(data) {
//  d3.csv('https://raw.githubusercontent.com/samhovie/sitefiles/main/NOFO_long.csv').then(function(data) {
  // console.log(data)
  
var prev_cases = 0;
  var prev_region = "";
  var prev_deaths = 0;
  var cases_max_diff = {};
  var deaths_max_diff = {};
  let parseDate = d3.timeParse("%Y-%m-%d");

  data.forEach((d) => {
    d.update_date = (d.update_date).substr(0,(d.update_date).indexOf(' '))
    d.update_date = parseDate(d.update_date);
    d.Positive_Cases = +d.Positive_Cases
    d.Tested = +d.Tested
    d.Deaths = +d.Deaths;
    d.new_cases = 0;
    d.new_deaths = 0;
    
    if ((prev_region.localeCompare(d.NOFO_Region)) !== 0) {
      //  console.log(d.NOFO_Region)
       cases_max_diff[d.NOFO_Region] = 0;
       deaths_max_diff[d.NOFO_Region] = 0;
       
       prev_cases = d.Positive_Cases;
       d.new_cases = d.Positive_Cases;
       
      prev_deaths = d.Deaths;
      d.new_deaths = d.Deaths;
      prev_region = d.NOFO_Region;
    } else {
      if (d.Positive_Cases < prev_cases) {
         d.new_cases = 0;
      } else {
         d.new_cases = d.Positive_Cases - prev_cases;
      }
      
      if (d.Deaths < prev_deaths) {
         d.new_deaths = 0;
         
      } else {
         d.new_deaths = d.Deaths - prev_deaths;
         
      }
      
      if( d.new_cases > cases_max_diff[d.NOFO_Region] ) {
         cases_max_diff[d.NOFO_Region] = d.new_cases;
         // console.log(d.update_date)
         
      } 
      
      if( d.new_deaths > deaths_max_diff[d.NOFO_Region] ) {
         deaths_max_diff[d.NOFO_Region] = d.new_deaths;
      } 
       
       prev_cases = d.Positive_Cases;
       prev_deaths = d.Deaths;
       prev_region = d.NOFO_Region;
    }

    
  });

        // let regionMap = {};
        let dict = {};
        
        dict["illinois"] = "Illinois";
        dict["covidregion_1"] = "Central";
        dict["covidregion_2"] = "Chicago";
        dict["covidregion_3"] = "Collar";
        dict["covidregion_4"] = "West Central";
        dict["covidregion_5"] = "North Central";
        dict["covidregion_6"] = "Northern";
        dict["covidregion_7"] = "Northwest";
        dict["covidregion_8"] = "Southeast Central";
        dict["covidregion_9"] = "Southern";
        dict["covidregion_10"] = "Southwest Central";
        dict["covidregion_11"] = "Suburban";
        
        
        var selectedGroupCases = dict[selectedGroup]
        
        // allGroup = d3.map(data, function(d){return(d.geography_modeled)}).keys();
        
        dataFilter = data.filter(function(d){return d.NOFO_Region==selectedGroupCases})
                        
        y_cases.domain([0, d3.max(dataFilter, function(d) { return d.new_cases })])
        y_cases_axis.call(d3.axisLeft(y_cases).ticks(6));
        
        y_deaths.domain([0, d3.max(dataFilter, function(d) { return d.new_deaths })])
        y_deaths_axis.call(d3.axisLeft(y_deaths).ticks(6));
        
        area_cases
        .datum(dataFilter)
        .transition()
        .duration(1000)
        .attr("fill", function(d){ return lightColors(selectedGroup) })
        .attr("d", d3.area()
        .x(function(d) { return x_cases(d.update_date) })
        .y0(y_cases(0))
        .y1(function(d) { return y_cases(d.new_cases) })
        ).attr("stroke", function(d){ return myColor(selectedGroup) } )
        
        
        area_deaths
        .datum(dataFilter)
        .transition()
        .duration(1000)
        .attr("fill", function(d){ return lightColors(selectedGroup) })
        .attr("d", d3.area()
        .x(function(d) { return x_deaths(d.update_date) })
        .y0(y_deaths(0))
        .y1(function(d) { return y_deaths(d.new_deaths) })
        ).attr("stroke", function(d){ return myColor(selectedGroup) } )
        
      });
       
    }
    
        
        
      // When the button is changed, run the updateChart funso ction
    d3.select("#selectButton").on("change", function(d) {
      // recover the option that has been chosen
      var selectedOption = d3.select(this).property("value")
      // run the updateChart function with this selected option
      // console.log(selectedOption)
      update(selectedOption)

    })
    

</script>