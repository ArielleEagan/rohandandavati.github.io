---
layout: default
title: Home
---
<style>
/*div {*/
/*   border: 1px solid red;*/
/*}*/
/*.bottom {*/
/*   height: 200px;*/
/*   position: relative;*/
/*}*/

.d3-tip, .tooltip {
   z-index: 2;
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  /*box-sizing: border-box;*/
  display: block;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
    .card {
    border-color:transparent !important;
    }
    .chart {
        z-index: 1;
        /*margin-bottom: 1%;*/
        
    }
    body {
        padding-top: 50px;
        padding-bottom:300px;
}
	.classy {
      fill:#009DAA;
    } 
 
   #cases_map {
      /*z-index: 2;*/   
      position: fixed;
      z-index: 2;
   }
   .card-body {
      /*width: 100%;*/
      margin-right: 20px;
   }
   /*.pos {*/
   /*   float: right;*/
   /*   position: relative;*/
   /*}*/

@media only screen and (max-width: 339px) {
      body {
         padding-top: 110px;
      }
      #cases_map {
         width: 20%;
         /*padding-top: 10px;*/
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }
}


@media only screen and (min-width: 339px) {
      body {
         padding-top: 90px;
         margin-right: 0%;
      }
      #cases_map {
         width: 20%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }

}

/* Small devices (portrait tablets and large phones, 600px and up) */
@media only screen and (min-width: 600px) {
      #cases_map {
         width: 18%;
      }
      body {
         padding-top: 70px;
      }
      #cases_map {
         width: 15%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
         margin-right: 0%;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }
}

/* Medium devices (landscape tablets, 768px and up) */
@media only screen and (min-width: 768px) {
      
      #cases_map {
         width: 15%;
      }
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Large devices (laptops/desktops, 992px and up) */
@media only screen and (min-width: 992px) {
   body{
      /*margin-left: 5%;*/
      margin-right: 10%;
   }
   #cases_map {
      margin-left: 1%;
         width: 10%;
}
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Extra large devices (large laptops and desktops, 1200px and up) */
@media only screen and (min-width: 1200px) {
   
      body{
      /*margin-left: 5%;*/
      margin-right: 12%;
   }
   #cases_map {
         width: 10%;
      }
}

</style>

<div class="map" id = "cases_map"></div>


<div class="card cases " id = "">
  <div class="card-body">
    <h2>Transmission Status</h2>
    <text>We estimate \(R_t\) is currently around <text id = "rt_text"></text> (95% CI <text id = "rt_text_lower"></text>-<text id = "rt_text_upper"></text>) for <text class = "region_text"></text> of Illinois. \(R_t\), the instantaneous
      reproductive number, tells us whether the epidemic is <i>growing</i> (\(R_t\) > 1), <i>shrinking</i> (\(R_t\) < 1), or
      staying the same (\(R_t\) = 1).</text>
  </div>
</div>

<div class = "card cases chart">
   <div class="card-body" id = "rt_chart"> </div>
</div>


<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases</h2>
    <text>This is the number of new infections discovered daily by diagnostic testing, as reported by the
      Illinois Department of Public Health. Individuals who receive multiple positive test results only count as one
      case. Bars show daily cases, and the line is a 7-day moving average.
      As of <text class = "last_update_date"></text>, an average of <text id = "avg_cases"></text> cases of SARS-CoV-2 infection are discovered daily in <text class = "region_text"></text>  of Illinois. </text>
  </div>
</div>

<div class = "card cases chart">
   <div class="card-body" id = "cases_chart"> </div>
</div>


<div class="card deaths " id = "">
  <div class="card-body">
    <h2>Deaths</h2>
    <text>This is the number of daily COVID-19 confirmed deaths reported to the Illinois Department of Public Health.
      Reporting of deaths often lags behind reporting of cases, so death counts do not necessarily reflect date of death
      but are likely within two weeks. Bars show daily deaths, and the line is a 7-day moving average.
      As of <text class = "last_update_date"></text>, an average of <text id = "avg_deaths"></text> confirmed COVID-19 deaths
      occur daily in <text class = "region_text"></text> of Illinois. </text>
  </div>
</div>

<div class = "card deaths chart">
   <div class="card-body" id = "deaths_chart"> </div>
</div>

<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases per Test (case positivity rate)</h2>
    <text>The case positivity rate is the number of cases discovered divided by the number of tests administered. This
      is not the same as the test positivity rate, which measures the number of positive tests per every test
      administered. Bars show the daily case positivity rate, and the line is a 7-day moving average.
      As of <text class = "last_update_date"></text>, an average of <text id = "avg_cases"></text> cases are discovered per test in <text class = "region_text"></text>  of Illinois. </text>
  </div>
</div>

<div class = "card deaths chart">
<div id="test_pos"></div>
</div>
<div class="card cases " id = "">
  <div class="card-body">
    <h2>Tests</h2>
    <text>This is the number of SARS-CoV-2 diagnostic tests administered daily in <text class = "region_text"></text> of Illinois. This count includes only
      molecular tests up to October 14, 2020 and includes both molecular and antigen tests after October 14, 2020.
      This count only includes diagnostic tests, which test for current SARS-CoV-2 infection. Serological tests, which
      test for past SARS-CoV-2 infection, are not included in this count. Bars show daily tests, and the line
      is a 7-day moving average. As of <text class = "last_update_date"></text>, an average of <text id = "avg_test"></text> tests are conducted daily in <text class = "region_text"></text>  of Illinois.
</text>
  </div>
</div>


<div class = "card deaths chart">
<div id="tests"></div>
</div>


<div id="bottom"></div>
---
layout: default
title: Home
---
<style>
/*div {*/
/*   border: 1px solid red;*/
/*}*/
/*.bottom {*/
/*   height: 200px;*/
/*   position: relative;*/
/*}*/

.d3-tip, .tooltip {
   z-index: 2;
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  /*box-sizing: border-box;*/
  display: block;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
    .card {
    border-color:transparent !important;
    }
    .chart {
        z-index: 1;
        /*margin-bottom: 1%;*/
        
    }
    body {
        padding-top: 50px;
        padding-bottom:300px;
}
	.classy {
      fill:#009DAA;
    } 
 
   #cases_map {
      /*z-index: 2;*/   
      position: fixed;
      z-index: 2;
   }
   .card-body {
      /*width: 100%;*/
      margin-right: 20px;
   }
   /*.pos {*/
   /*   float: right;*/
   /*   position: relative;*/
   /*}*/

@media only screen and (max-width: 339px) {
      body {
         padding-top: 110px;
      }
      #cases_map {
         width: 20%;
         /*padding-top: 10px;*/
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }
}


@media only screen and (min-width: 339px) {
      body {
         padding-top: 90px;
         margin-right: 0%;
      }
      #cases_map {
         width: 20%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }

}

/* Small devices (portrait tablets and large phones, 600px and up) */
@media only screen and (min-width: 600px) {
      #cases_map {
         width: 18%;
      }
      body {
         padding-top: 70px;
      }
      #cases_map {
         width: 15%;
         /*border: solid red 1px;*/
      }
      .rt {
         width: 100%;
         float: right;
         margin-right: 0%;
      }
      .cases {
         width: 100%;
         float: right;
      }
      .deaths {
         width: 100%;
         float: right;
      }
}

/* Medium devices (landscape tablets, 768px and up) */
@media only screen and (min-width: 768px) {
      
      #cases_map {
         width: 15%;
      }
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Large devices (laptops/desktops, 992px and up) */
@media only screen and (min-width: 992px) {
   body{
      /*margin-left: 5%;*/
      margin-right: 10%;
   }
   #cases_map {
      margin-left: 1%;
         width: 10%;
}
      .card {
         margin-right: 5%;
         width: 80%;
      }
}

/* Extra large devices (large laptops and desktops, 1200px and up) */
@media only screen and (min-width: 1200px) {
   
      body{
      /*margin-left: 5%;*/
      margin-right: 12%;
   }
   #cases_map {
         width: 10%;
      }
}

</style>

<div class="map" id = "cases_map"></div>


<div class="card cases " id = "">
  <div class="card-body">
    <h2>Transmission Status</h2>
    <text>We estimate \(R_t\) is currently around <text id = "rt_text"></text> (95% CI <text id = "rt_text_lower"></text>-<text id = "rt_text_upper"></text>) for <text class = "region_text"></text> of Illinois. \(R_t\), the instantaneous
      reproductive number, tells us whether the epidemic is <i>growing</i> (\(R_t\) > 1), <i>shrinking</i> (\(R_t\) < 1), or
      staying the same (\(R_t\) = 1).</text>
  </div>
</div>

<div class = "card cases chart">
   <div class="card-body" id = "rt_chart"> </div>
</div>


<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases</h2>
    <text>This is the number of new infections discovered daily by diagnostic testing, as reported by the
      Illinois Department of Public Health. Individuals who receive multiple positive test results only count as one
      case. Bars show daily cases, and the line is a 7-day moving average.
      As of <text class = "last_update_date"></text>, an average of <text id = "avg_cases"></text> cases of SARS-CoV-2 infection are discovered daily in <text class = "region_text"></text>  of Illinois. </text>
  </div>
</div>

<div class = "card cases chart">
   <div class="card-body" id = "cases_chart"> </div>
</div>


<div class="card deaths " id = "">
  <div class="card-body">
    <h2>Deaths</h2>
    <text>This is the number of daily COVID-19 confirmed deaths reported to the Illinois Department of Public Health.
      Reporting of deaths often lags behind reporting of cases, so death counts do not necessarily reflect date of death
      but are likely within two weeks. Bars show daily deaths, and the line is a 7-day moving average.
      As of <text class = "last_update_date"></text>, an average of <text id = "avg_deaths"></text> confirmed COVID-19 deaths
      occur daily in <text class = "region_text"></text> of Illinois. </text>
  </div>
</div>

<div class = "card deaths chart">
   <div class="card-body" id = "deaths_chart"> </div>
</div>

<div class="card cases " id = "">
  <div class="card-body">
    <h2>Cases per Test (case positivity rate)</h2>
    <text>The case positivity rate is the number of cases discovered divided by the number of tests administered. This
      is not the same as the test positivity rate, which measures the number of positive tests per every test
      administered. Bars show the daily case positivity rate, and the line is a 7-day moving average.
      As of <text class = "last_update_date"></text>, an average of <text id = "avg_cases"></text> cases are discovered per test in <text class = "region_text"></text>  of Illinois. </text>
  </div>
</div>

<div class = "card deaths chart">
<div id="test_pos"></div>
</div>
<div class="card cases " id = "">
  <div class="card-body">
    <h2>Tests</h2>
    <text>This is the number of SARS-CoV-2 diagnostic tests administered daily in <text class = "region_text"></text> of Illinois. This count includes only
      molecular tests up to October 14, 2020 and includes both molecular and antigen tests after October 14, 2020.
      This count only includes diagnostic tests, which test for current SARS-CoV-2 infection. Serological tests, which
      test for past SARS-CoV-2 infection, are not included in this count. Bars show daily tests, and the line
      is a 7-day moving average. As of <text class = "last_update_date"></text>, an average of <text id = "avg_test"></text> tests are conducted daily in <text class = "region_text"></text>  of Illinois.
</text>
  </div>
</div>


<div class = "card deaths chart">
<div id="tests"></div>
</div>


<div id="bottom"></div>
<script>
   /* global d3 */
   /* global $ */

   
   function LightenDarkenColor(col,amt) {
      var usePound = false;
      if ( col[0] == "#" ) {
         col = col.slice(1);
         usePound = true;
      }
      var num = parseInt(col,16);
      
      var r = (num >> 16) + amt;
      if ( r > 255 ) r = 255;
      else if  (r < 0) r = 0;
      
      var b = ((num >> 8) & 0x00FF) + amt;
      if ( b > 255 ) b = 255;
      else if  (b < 0) b = 0;
      
      var g = (num & 0x0000FF) + amt;
      if ( g > 255 ) g = 255;
      else if  ( g < 0 ) g = 0;
      
      return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
   }
   
//  //orginal colors sent
//    var hexColors = ["#BA3E39", "#BA7FB7","#89D0C5", "#F9B554", "#969696", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#DCC29C"]
//    var mapFill = ["#740000", "#743971", "#438a7f", "#b36f0e", "#505050", "#777396", "#ae3928", "#396797", "#6d8f1a", "#b38197", "#a48500", "#967c56"]
//    var hexColorsLight = ["#c0514c", "#c08bbe","#94d4ca", "#f9bc65", "#a0a0a0", "#c3c0df", "#f58b7c", "#8bb5e0", "#bad96f", "#f9cce0", "#ecd056", "#dfc8a5"]
//    var hexColorsLighter = ["#c76460", "#c798c5","#a0d9d0", "#fac376", "#ababab", "#cac7e3", "#f6988b", "#98bde3", "#c2dd7f", "#fad2e3", "#eed569", "#e3ceaf"]
//    var hexColorsLightest = ["#ce7774", "#cea5cc","#acded6", "#facb87", "#b5b5b5", "#d0cee6", "#f7a599", "#a5c5e7", "#c9e18f", "#fad7e7", "#f0da7c", "#e6d4b9"]
   
   //region color swap issue #29
   var hexColors = ["#969696", "#BA7FB7","#89D0C5", "#F9B554", "#DCC29C", "#BDB9DC", "#F47F6E", "#7FADDD", "#B3D560", "#F9C7DD", "#EACB44", "#BA3E39"] 
   
   var mapFill = ["#505050", "#743971", "#438a7f", "#b36f0e", "#967c56", "#777396", "#ae3928", "#396797", "#6d8f1a", "#b38197", "#a48500", "#740000"]

   var hexColorsLight = ["#a0a0a0", "#c08bbe","#94d4ca", "#f9bc65", "#dfc8a5", "#c3c0df", "#f58b7c", "#8bb5e0", "#bad96f", "#f9cce0", "#ecd056", "#c0514c"]

   var hexColorsLighter = ["#ababab", "#c798c5","#a0d9d0", "#fac376", "#e3ceaf", "#cac7e3", "#f6988b", "#98bde3", "#c2dd7f", "#fad2e3", "#eed569", "#c76460"]

   var hexColorsLightest = ["#b5b5b5", "#cea5cc","#acded6", "#facb87", "#e6d4b9", "#d0cee6", "#f7a599", "#a5c5e7", "#c9e18f", "#fad7e7", "#f0da7c", "#ce7774"]

   var firstIteration = true;
   
   let allGroup = ["illinois", "covidregion_1", "covidregion_2", "covidregion_3", 
                   "covidregion_4", "covidregion_5", "covidregion_6", "covidregion_7", 
                   "covidregion_8", "covidregion_9", "covidregion_10", "covidregion_11"]

     d3.select("#selectButton")
    .selectAll('myOptions')
    .data(allGroup)
    .enter()
    .append('option')
    .text(function (d) { 
                         if(d == "illinois" ||d == "Illinois" ) {
                              return "Illinois";
                          }
                          d = "Region " + d.substring( d.indexOf('_')+1);
                          return d; 
                        })
    .attr("value", function (d) { return d; })
    .attr("class", "dropdown-item")
    
    var mapFillColor = d3.scaleOrdinal().domain(allGroup)
     .range(mapFill)
     
    var colors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColors)
     
   var lightColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLight)
     
   var lighterColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLighter)
     
   var lightestColors = d3.scaleOrdinal().domain(allGroup)
     .range(hexColorsLightest)
  
   
   var countyMap = {
      "ADAMS": {
         "covid_region": 3
      },
      "ALEXANDER": {
         "covid_region": 5
      },
      "BOND": {
         "covid_region": 4
      },
      "BOONE": {
         "covid_region": 1
      },
      "BROWN": {
         "covid_region": 3
      },
      "BUREAU": {
         "covid_region": 2
      },                   
      "CALHOUN": {
         "covid_region": 3
      },
      "CARROLL": {
         "covid_region": 1
      },
      "CASS": {
         "covid_region": 3
      },
      "CHAMPAIGN": {
         "covid_region": 6
      },
      "CHICAGO": {
         "covid_region": 11
      },
      "CHRISTIAN": {
         "covid_region": 3
      },
      "CLARK": {
         "covid_region": 6
      },
      "CLAY": {
         "covid_region": 6
      },
      "CLINTON": {
         "covid_region": 4
      },
      "COLES": {
         "covid_region": 6
      },
      "COOK": {
         "covid_region": 10
      },
      "SUBURBAN COOK": {
         "covid_region": 10
      },
      "CRAWFORD": {
         "covid_region": 6
      },
      "CUMBERLAND": {
         "covid_region": 6
      },
      "DE WITT": {
         "covid_region": 6
      },
      "DEKALB": {
         "covid_region": 1
      },
      "DOUGLAS": {
         "covid_region": 6
      },
      "DUPAGE": {
         "covid_region": 8
      },
      "EDGAR": {
         "covid_region": 6
      },
      "EDWARDS": {
         "covid_region": 5
      },
      "EFFINGHAM": {
         "covid_region": 6
      },
      "FAYETTE": {
         "covid_region": 6
      },
      "FORD": {
         "covid_region": 6
      },
      "FRANKLIN": {
         "covid_region": 5
      },
      "FULTON": {
         "covid_region": 2
      },
      "GALLATIN": {
         "covid_region": 5
      },
      "GREENE": {
         "covid_region": 3
      },
      "GRUNDY": {
         "covid_region": 2
      },
      "HAMILTON": {
         "covid_region": 5
      },
      "HANCOCK": {
         "covid_region": 3
      },
      "HARDIN": {
         "covid_region": 5
      },
      "HENDERSON": {
         "covid_region": 2
      },
      "HENRY": {
         "covid_region": 2
      },
      "IROQUOIS": {
         "covid_region": 6
      },
      "JACKSON": {
         "covid_region": 5
      },
      "JASPER": {
         "covid_region": 6
      },
      "JEFFERSON": {
         "covid_region": 5
      },
      "JERSEY": {
         "covid_region": 3
      },
      "JO DAVIESS": {
         "covid_region": 1
      },
      "JOHNSON": {
         "covid_region": 5
      },
      "KANE": {
         "covid_region": 8
      },
      "KANKAKEE": {
         "covid_region": 7
      },
      "KENDALL": {
         "covid_region": 2
      },
      "KNOX": {
         "covid_region": 2
      },
      "LAKE": {
         "covid_region": 9
      },
      "LASALLE": {
         "covid_region": 2
      },
      "LAWRENCE": {
         "covid_region": 6
      },
      "LEE": {
         "covid_region": 1
      },
      "LIVINGSTON": {
         "covid_region": 2
      },
      "LOGAN": {
         "covid_region": 3
      },
      "MACON": {
         "covid_region": 6
      },
      "MACOUPIN": {
         "covid_region": 3
      },
      "MADISON": {
         "covid_region": 4
      },
      "MARION": {
         "covid_region": 5
      },
      "MARSHALL": {
         "covid_region": 2
      },
      "MASON": {
         "covid_region": 3
      },
      "MASSAC": {
         "covid_region": 5
      },
      "MCDONOUGH": {
         "covid_region": 2
      },
      "MCHENRY": {
         "covid_region": 9
      },
      "MCLEAN": {
         "covid_region": 2
      },
      "MENARD": {
         "covid_region": 3
      },
      "MERCER": {
         "covid_region": 2
      },
      "MONROE": {
         "covid_region": 4
      },
      "MONTGOMERY": {
         "covid_region": 3
      },
      "MORGAN": {
         "covid_region": 3
      },
      "MOULTRIE": {
         "covid_region": 6
      },
      "OGLE": {
         "covid_region": 1
      },
      "PEORIA": {
         "covid_region": 2
      },
      "PERRY": {
         "covid_region": 5
      },
      "PIATT": {
         "covid_region": 6
      },
      "PIKE": {
         "covid_region": 3
      },
      "POPE": {
         "covid_region": 5
      },
      "PULASKI": {
         "covid_region": 5
      },
      "PUTNAM": {
         "covid_region": 2
      },
      "RANDOLPH": {
         "covid_region": 4
      },
      "RICHLAND": {
         "covid_region": 6
      },
      "ROCK ISLAND": {
         "covid_region": 2
      },
      "SALINE": {
         "covid_region": 5
      },
      "SANGAMON": {
         "covid_region": 3
      },
      "SCHUYLER": {
         "covid_region": 3 
      },
      "SCOTT": {
         "covid_region": 3
      },
      "SHELBY": {
         "covid_region": 6
      },
      "ST. CLAIR": {
         "covid_region": 4
      },
      "STARK": {
         "covid_region": 2
      },
      "STEPHENSON": {
         "covid_region": 1
      },
      "TAZEWELL": {
         "covid_region": 2
      },
      "UNION": {
         "covid_region": 5
      },
      "VERMILION": {
         "covid_region": 6
      },
      "WABASH": {
         "covid_region": 5
      },
      "WARREN": {
         "covid_region": 2
      },
      "WASHINGTON": {
         "covid_region": 4
      },
      "WAYNE": {
         "covid_region": 5
      },
      "WHITE": {
         "covid_region": 5
      },
      "WHITESIDE": {
         "covid_region": 1
      },
      "WILL": {
         "covid_region": 7
      },
      "WILLIAMSON": {
         "covid_region": 5
      },
      "WINNEBAGO": {
         "covid_region": 1
      },
      "WOODFORD": {
         "covid_region": 2
      },
      "ILLINOIS": {
         "covid_region": 0
      }
   }
   
   var margin_rt = {top: 15, right: 10, bottom: 50, left: 40};
   var margin_cases = {top: 15, right: 20, bottom: 50, left: 40};
   var margin_deaths = {top: 15, right: 10, bottom: 50, left: 40};
   var margin_test_pos = {top: 15, right: 30, bottom: 50, left: 60};
   var margin_tests = {top: 15, right: 10, bottom: 50, left: 60};
   
   var svg_rt = d3.select("#rt_chart").append("svg")    
   .style("fill", "none")
    .style("pointer-events", "all")
   
   var x_rt = d3.scaleTime();
   var x_rt_axis = svg_rt.append("g");
   var y_rt = d3.scaleLinear();
   var y_rt_axis = svg_rt.append("g");
   
   var interval_rt = svg_rt.append("path")
      .attr("stroke", "none")
      .attr("transform", "translate("+ 0 +","+ 0  + ")"  );
   
   var line_rt = svg_rt.append('g').append("path")  
   .attr("transform", "translate("+ 0 +","+ 0  + ")"  )
      .style("stroke-width", 2)
      .style("fill", "none");
      
      var interval_rt2 = svg_rt.append("path")
      .attr("stroke", "none")
      .attr("transform", "translate("+ 0 +","+ 0  + ")"  );
   
   var line_rt2 = svg_rt.append('g').append("path")  
   .attr("transform", "translate("+ 0 +","+ 0  + ")"  )
      .style("stroke-width", 2)
      .style("fill", "none");
      
   var refLine = svg_rt.append('g').append("path")
   .attr("stroke", "black")
   .attr("transform", "translate("+ 0 +","+ 0  + ")"  )
      .style("stroke-width", 1)
      .style("stroke-dasharray", ("3, 3"))
      .style("fill", "none")
   
   var dataFilter = null; 
   
   var svg_deaths = d3.select("#deaths_chart").append("svg")
	var svg_map = d3.select("#cases_map").append("svg")
	var svg_cases = d3.select("#cases_chart").append("svg")
	var svg_test_pos = d3.select("#test_pos").append("svg")
	var svg_tests = d3.select("#tests").append("svg")


	 // This allows to find the closest X index of the mouse:
  var bisect = d3.bisector(function(d) { return d.date; }).left;

 // Create the circle that travels along the curve of chart
 var focus = d3.select("#rt_chart")
    .append('g')
    .append('circle')
      .style("fill", "none")
      .attr("stroke", "black")
      .attr('r', 4.5)
      .style("opacity", 0)
      .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top  + ")"  );

var Tooltip = d3.select("#rt_chart")
    .append("div")
    .attr("class", "tooltip")
   
   
var projection = d3.geoAlbers()
var path = d3.geoPath()

var selectedRegion = 'illinois';


var x_cases = d3.scaleBand()
var y_cases = d3.scaleLinear()

var x_axis = svg_cases.append("g")
var y_axis = svg_cases.append("g")



var x_deaths= d3.scaleBand()
var y_deaths = d3.scaleLinear()

var x_axis_deaths = svg_deaths.append("g")
var y_axis_deaths = svg_deaths.append("g")



var x_test_pos= d3.scaleBand()
var y_test_pos = d3.scaleLinear()

var x_axis_tests_pos = svg_test_pos.append("g")
var y_axis_tests_pos = svg_test_pos.append("g")


var x_tests= d3.scaleBand()
var y_tests = d3.scaleLinear()
var x_axis_tests = svg_tests.append("g")
var y_axis_tests = svg_tests.append("g")

var files = [
             'https://raw.githubusercontent.com/samhovie/sitefiles/main/il-counties.json', 
             'https://raw.githubusercontent.com/samhovie/sitefiles/main/nu_20201027.csv',
            //  'https://raw.githubusercontent.com/samhovie/sitefiles/main/COVIDHistoricalTestResults.json'
            'https://cors-anywhere.herokuapp.com/https://www.dph.illinois.gov/sitefiles/COVIDHistoricalTestResults.json'
            // ,'https://raw.githubusercontent.com/rohandandavati/rohandandavati.github.io/master/_data/rtNU.csv?token=AICABR4NYAQPXFUEAEU7NWS76CISQ'
            
            ,'https://raw.githubusercontent.com/rohandandavati/rohandandavati.github.io/master/_data/rtNU.csv?token=AICABR63LU42JKEC45HUMEK77HNBC'
            //  ,'https://idph.illinois.gov/DPHPublicInformation/api/covidexport/GetCountyHistoricalTestResults?reportDate=10/10/2020'
            ]

   let map = {};
      map["illinois"] = "Illinois";
      map["covidregion_1"] = "Central";
      map["covidregion_2"] = "Chicago";
      map["covidregion_3"] = "Collar";
      map["covidregion_4"] = "West Central";
      map["covidregion_5"] = "North Central";
      map["covidregion_6"] = "Northern";
      map["covidregion_7"] = "Northwest"; 
      map["covidregion_8"] = "Southeast Central";
      map["covidregion_9"] = "Southern";
      map["covidregion_10"] = "Southwest Central";
      map["covidregion_11"] = "Suburban";


   let regionArray = [];
      regionArray[0] = "Illinois";
      regionArray[1] = "Central";
      regionArray[2] = "Chicago";
      regionArray[3] = "Collar";
      regionArray[4] = "West Central";
      regionArray[5] = "North Central";
      regionArray[6] = "Northern";
      regionArray[7] = "Northwest"; 
      regionArray[8] = "Southeast Central";
      regionArray[9] = "Southern";
      regionArray[10] = "Southwest Central";
      regionArray[11] = "Suburban";

var promises = [];
let today = new Date();
let parDate = d3.timeParse("%m/%d/%Y");

files.forEach(function(url) {
    if (url.slice(-1) === 'n'){
       promises.push(d3.json(url))
    }else{
       promises.push(d3.csv(url))
    }
});



Promise.all(promises).then(function(data) {
   

   let parseDate2 = d3.timeParse("%m/%d/%Y");
// let today = new Date();
var index = data[3].length - 1;

while (index >= 0) {
    if(isNaN(data[3][index].rt_median) || 
          parseDate2(data[3][index].date) > today  
      ){
         data[3].splice(index, 1);
      } else {
         data[3][index].rt_lower = +data[3][index].rt_lower;
         data[3][index].rt_median = +data[3][index].rt_median;
         data[3][index].rt_upper = +data[3][index].rt_upper;
         data[3][index].date = parseDate2(data[3][index].date);
         data[3][index].model_date = parseDate2(data[3][index].model_date);
      }
 index -= 1;
}

   var prev_date = parDate('11/11/1997')
   var region = 0;
   data[3].forEach(d => {
      //if date is increasing
      if( (d.date).getTime() > prev_date.getTime() ){
         d.geography_modeled = allGroup[region];
      }
      //date is less or eq, new region
      else {
         region += 1;
         d.geography_modeled = allGroup[region];
      }
      prev_date = d.date;
   });
   

//clean rt    
let parseDate = d3.timeParse("%Y-%m-%d");
// let today = new Date();
var index = data[1].length - 1;

while (index >= 0) {
    if(isNaN(data[1][index].rt_median) || 
          data[1][index].scenario_name !== 'baseline' ||
          parseDate(data[1][index].date) > today  
      ){
         data[1].splice(index, 1);
      } else {
         data[1][index].rt_lower = +data[1][index].rt_lower;
         data[1][index].rt_median = +data[1][index].rt_median;
         data[1][index].rt_upper = +data[1][index].rt_upper;
         data[1][index].date = parseDate(data[1][index].date);
      }
 index -= 1;
}

let dailyRegionCount = {}
      //reset to 0 after every day
      dailyRegionCount["Illinois"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Central"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Chicago"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Collar"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["West Central"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["North Central"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Northern"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Northwest"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Southeast Central"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Southern"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Southwest Central"] = {cases: 0, deaths: 0, tests: 0};
      dailyRegionCount["Suburban"] = {cases: 0, deaths: 0, tests: 0};

   
   var c = data[2].historical_county.values

   c.sort(function(a, b) {
   //if (a is less than b by some ordering criterion) {
   if (parDate(a.testDate).getTime() < parDate(b.testDate).getTime()) {
      return -1;
   }
   //  if (a is greater than b by the ordering criterion) {
   if (parDate(a.testDate).getTime() > parDate(b.testDate).getTime()) {
      return 1;
   }
   if (parDate(a.testDate).getTime() === parDate(b.testDate).getTime()) {
      return 0;
   }
})
   
   
   var historical_county = []

   var prev_dict = JSON.parse(JSON.stringify(dailyRegionCount))
   
   var i = 0;
   c.forEach( value => {
      //clear dictionary
      regionArray.forEach(region => {
         dailyRegionCount[region].cases = 0;
         dailyRegionCount[region].deaths = 0;
         dailyRegionCount[region].tests = 0;
      })
      
      //filter county array 
      var values = (value.values).filter(function(d){return !(d.County==="Out Of State" || d.County==="Unassigned")})
      //remember date
      
      
      var date = parDate(value.testDate)

      //loop county array for that day
      values.forEach( county => {
         //sum for that day
         dailyRegionCount[regionArray[countyMap[(county.County).toUpperCase()].covid_region]].cases += county.confirmed_cases
         dailyRegionCount[regionArray[countyMap[(county.County).toUpperCase()].covid_region]].deaths += county.deaths
         dailyRegionCount[regionArray[countyMap[(county.County).toUpperCase()].covid_region]].tests += county.total_tested
      })
      
      regionArray.forEach( region => {
      
      var cases = dailyRegionCount[region].cases - prev_dict[region].cases
       var test_pos = 0;
             
      if ((dailyRegionCount[region].tests - prev_dict[region].tests) > 0)    {

         test_pos =  (dailyRegionCount[region].cases - prev_dict[region].cases) / 
                            (dailyRegionCount[region].tests - prev_dict[region].tests)
      } 
         //if overcounted                   
         if (cases < 0 || isNaN(cases)) {
            cases = 0;
         }
         
         historical_county.push({
            date: date,
            NOFO_Region: region,
            // cases:  dailyRegionCount[region].cases - prev_dict[region].cases,
            cases: cases,
            deaths: dailyRegionCount[region].deaths - prev_dict[region].deaths,
            tested: dailyRegionCount[region].tests - prev_dict[region].tests,
            // test_positivity: (dailyRegionCount[region].cases - prev_dict[region].cases) / 
            //                 (dailyRegionCount[region].tests - prev_dict[region].tests)
            test_positivity: test_pos
         });
      })
      
      const POINTS_AVERAGE = 6;
      var pos = historical_county.length-1;
      //for each region at the end of array 
      for (let k = 0; k < 12; k++) {
         var cases_r = 0
         var cases_avg = 0
         var deaths_r = 0
         var deaths_avg = 0
         var test_pos_r =0
         var test_pos_avg =0
         var tests_r =0
         var tests_avg = 0;
         
         for (let j = 0; j <= POINTS_AVERAGE; j++) {
            if (i - j >= 0) {
               var jump = j * 12; 
               cases_avg += historical_county[pos - k - jump].cases;
               deaths_avg += historical_county[pos - k - jump].deaths;
               test_pos_avg += historical_county[pos - k - jump].test_positivity;
               tests_avg += historical_county[pos - k - jump].tested;
               cases_r = Math.floor(cases_avg / (j + 1));
               deaths_r = Math.floor(deaths_avg / (j + 1));
               test_pos_r = test_pos_avg / (j + 1);
               tests_r = Math.floor(tests_avg / (j + 1));
            } else {
               cases_r = Math.floor(cases_avg / j);
               deaths_r = Math.floor(deaths_avg / j);
               test_pos_r = Math.floor(test_pos_r / j);
               tests_r = Math.floor(tests_avg / j);
               j = POINTS_AVERAGE + 1;
            }
         }
         historical_county[pos-k].cases_avg = cases_r;
         historical_county[pos-k].deaths_avg = deaths_r;
         historical_county[pos-k].test_pos_avg = test_pos_r;
         historical_county[pos-k].tests_avg = tests_r;
      }
      i += 1;
      prev_dict = JSON.parse(JSON.stringify(dailyRegionCount))
   });

function drawChart() {
   
   let selectToRegion = {};
      selectToRegion["illinois"] = "Illinois";
      selectToRegion["covidregion_1"] = "Central";
      selectToRegion["covidregion_2"] = "Chicago";
      selectToRegion["covidregion_3"] = "Collar";
      selectToRegion["covidregion_4"] = "West Central";
      selectToRegion["covidregion_5"] = "North Central";
      selectToRegion["covidregion_6"] = "Northern";
      selectToRegion["covidregion_7"] = "Northwest"; 
      selectToRegion["covidregion_8"] = "Southeast Central";
      selectToRegion["covidregion_9"] = "Southern";
      selectToRegion["covidregion_10"] = "Southwest Central";
      selectToRegion["covidregion_11"] = "Suburban";

      var currentWidth = document.getElementById("rt_chart").offsetWidth;
      
      const width_rt = currentWidth- margin_rt.left - margin_rt.right;
      let height_rt = parseInt(currentWidth * 0.35 ) - margin_rt.top - margin_rt.bottom;

      if (parseInt(currentWidth) < 600) {
         height_rt = parseInt(currentWidth * .72) - margin_rt.top - margin_rt.bottom;
      }
      else if (parseInt(currentWidth) < 900) {
         height_rt = parseInt(currentWidth * .62) - margin_rt.top - margin_rt.bottom;
      }

      currentWidth = document.getElementById("cases_chart").offsetWidth;
      const width_cases = currentWidth- margin_cases.left - margin_cases.right;
      let height_cases = parseInt(currentWidth * 0.35 ) - margin_cases.top - margin_cases.bottom;
      
      if (parseInt(currentWidth) < 600) {
         height_cases = parseInt(currentWidth * .72) - margin_cases.top - margin_cases.bottom;
      }
      else if (parseInt(currentWidth) < 900) {
         height_cases = parseInt(currentWidth * .62) - margin_cases.top - margin_cases.bottom;
      }
      
      
   var map_wid = document.getElementById("cases_map").offsetWidth;
   var map_hid = map_wid *2;

   var tip_map = d3.tip()
                   .attr('class', 'd3-tip')
                   .offset([-10, 0])
                   .html(function(d) {
                     return "County: <span style='color:red'>" + d.properties.COUNTY_NAM + "</span> <br></br>" + 
                     "Region:<span style='color:red'> " + countyMap[d.properties.COUNTY_NAM].covid_region + "</span> " ;
                  })
  
   Array.prototype.forEach.call(document.querySelectorAll('.d3-tip'), (t) => t.parentNode.removeChild(t));
      
   svg_map.attr("width", map_wid )
	       .attr("height", map_hid)
	       
	       svg_map.call(tip_map)
	       
   projection.rotate([89.5,0]).fitWidth(map_wid, data[0]);
   
   path.projection(projection);
  
   svg_map.append("g")
   
       var map = svg_map.selectAll("path")
       .data(data[0].features)
       
       map.enter()
       .append("path")
       .merge(map)
       .attr( "d", path )
       .attr("fill", function(d){ 
         if (selectedRegion.localeCompare("illinois") === 0) {
            return colors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region])
         } else {
             if (countyMap[d.properties.COUNTY_NAM].covid_region === parseInt(selectedRegion.split('_')[1])) {
                   return colors(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
            } else {
                     return "#7E7E7E" 
            }
         }
      })
      .attr("stroke", function(d){ 
           if (selectedRegion.localeCompare("illinois") === 0) {
               return mapFillColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region])
            } else {
           if (
             countyMap[d.properties.COUNTY_NAM].covid_region ===
             parseInt(selectedRegion.split('_')[1])) {
                   return mapFillColor(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) 
            } else {
               return "#AAAAAA" 
            }
         }
      }) 
      .on('mouseover', tip_map.show)
      .on('mouseout', tip_map.hide)
      .on('click', function(d) {
         // tip_map.hide
         if (selectedRegion.localeCompare(allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]) === 0 ) {
            selectedRegion = 'illinois'
         } else {
            selectedRegion = allGroup[countyMap[d.properties.COUNTY_NAM].covid_region]
         }
         d3.select('#selectButton').property('value', selectedRegion);
         drawChart()
    })
      
   map
   .exit()
   .remove()
   
   var dataFilter = data[1].filter(function(d){return d.geography_modeled==selectedRegion}) 
   var dataFilter2 = data[3].filter(function(d){return d.geography_modeled==selectedRegion}) 
   
      var selectedGroupCases = selectToRegion[selectedRegion]
    var data_map = historical_county.filter(function(d){return d.NOFO_Region==selectedGroupCases})
   var formatDate = d3.timeFormat("%b %d")
   
  
  var mousemove = function(d) {
         // var formatTime = d3.timeFormat("%b %d")"%b %Y"
         var formatTime = d3.timeFormat("%b %d")
    var x0 = x_rt.invert(d3.mouse(this)[0]);
    var i = bisect(dataFilter, x0, 1);
    var selectedData = dataFilter[i]
    Tooltip
      // .html(tickTimeFormat(d.date) + "<br></br><strong>R<sub>t</sub>:</strong> <span style='color:red'>" + parseFloat((selectedData.rt_median)).toFixed(2) + "</span>" )
      .html( formatTime(selectedData.date) +"<br></br><strong>R<sub>t</sub>:</strong> <span style='color:red'> "+  parseFloat((selectedData.rt_median)).toFixed(2) + "</span>")
      
      // .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("left", (x_rt(selectedData.date)+90) + "px")
      .style("top",  (y_rt(selectedData.rt_median)+40) + "px")
   focus
      .attr("cx", x_rt(selectedData.date))
      .attr("cy", y_rt(selectedData.rt_median))
   }
  
    x_rt
      .domain(d3.extent(dataFilter , function(d) { return d.date}))
      .range([ 0, width_rt]);
   
   y_rt
   .domain([0, 2.0]);
   
   svg_rt
      .attr("width", width_rt + margin_rt.left + margin_rt.right)
      .attr("height", height_rt + margin_rt.top + margin_rt.bottom)
   .append("g")
      .attr("transform", "translate(" + margin_rt.left + "," + margin_rt.top + ")");
      
   const formatTime = d3.timeFormat("%b %Y");
      
   let ticks = 0
   if (currentWidth < 600) {
      ticks = 5
   }else {
      ticks = 6
   }
   
   x_rt_axis
      .attr("transform", "translate(" + margin_rt.left + "," + (height_rt + margin_rt.top) + ")")
      .call(d3.axisBottom(x_rt).tickFormat(d3.timeFormat("%b %Y")).ticks(ticks))
      .call(x_rt_axis => x_rt_axis.select(".domain").remove())
      
   y_rt
      .range([ height_rt, 0 ])
   
   y_rt_axis
      .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top + ")"  )
      // .call(d3.axisLeft(y_rt).ticks(6))
      .call(d3.axisLeft(y_rt))
      .call(y_rt_axis => y_rt_axis.select(".domain").remove())

   
   svg_rt
      .select(".yLabel")
      .remove()
   
   //rt y label 
   svg_rt
   .append('text')
      .attr("class", "yLabel")
       .attr("text-anchor", "end") 
       .attr("y", 5)
       .attr("dy", ".40em")
       .style("fill", "#242526")
       .attr("transform", "rotate(-90)")
     .html('Reproductive Number - R')
     .style('font-size', '1rem')
    .append('tspan')
       .text('t')
       .style('font-size', '.8rem')
      //  .style('font-weight', 'bold')
       .attr('dx', '.1em')
       .attr('dy', '.3em')


   interval_rt.attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top + ")"  )
   interval_rt2.attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top + ")"  )
   
   
   interval_rt
      .datum(dataFilter)
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      .transition()
      .duration(1000)
      .attr("d", d3.area()
      .x(function(d) { return x_rt(d.date) })
      .y0(function(d) { return y_rt(d.rt_lower) })
      .y1(function(d) { return y_rt(d.rt_upper) }))
      
      
   interval_rt2
      .datum(dataFilter2)
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      .transition()
      .duration(1000)
      .attr("d", d3.area()
      .x(function(d) { return x_rt(d.date) })
      .y0(function(d) { return y_rt(d.rt_lower) })
      .y1(function(d) { return y_rt(d.rt_upper) }))
   
   line_rt.attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top + ")"  )
   line_rt2.attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top + ")"  )
   
   line_rt
      .datum(dataFilter)
      .attr("stroke", function(d){ return colors(selectedRegion) })
      .transition()
      .duration(1000)
      .attr("d", d3.line()
      .x(function(d) { return x_rt(d.date) })
      .y(function(d) { return y_rt(d.rt_median) })
      )
   
      line_rt2
      .datum(dataFilter2)
      .attr("stroke", function(d){ return colors(selectedRegion) })
      .transition()
      .duration(1000)
      .attr("d", d3.line()
      .x(function(d) { return x_rt(d.date) })
      .y(function(d) { return y_rt(d.rt_median) })
      )
   
   refLine.attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top + ")"  )
   
   refLine
      .datum(dataFilter)
      .transition()
      .duration(1000)
      .attr("d", d3.line()
      .x(function(d) { return x_rt(d.date) })
      .y(function(d) { return y_rt(1.0) }));

   svg_rt
      .append('rect')
      .attr('width', width_rt)
      .attr('height', height_rt)
      .attr("transform", "translate("+ margin_rt.left +","+ margin_rt.top + ")"  )
      .on("mouseover", function(d) {
     focus.style("opacity", 1)
    Tooltip
      .style("opacity", 1)
  })
      .on("mousemove", mousemove)
      .on("mouseleave", function(d) {
     focus.style("opacity", 0)
    Tooltip
      .style("opacity", 0)
  })
   
    var tickTimeFormat = d3.timeFormat("%b %d")
   var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
         // return tickTimeFormat(d.date) + "<br></br><strong>Cases:</strong> <span style='color:red'>" + d.cases + "</span>" ;
     return tickTimeFormat(d.date) + "<br></br>Cases:<span style='color:red'>" + d.cases + "</span><br></br>" +
     "7-Day Average: <span style='color:red'>" + d.cases_avg;
  })
//     return "<strong>Cases:</strong> <span style='color:red'>" + d.cases + "</span><br></br>" + 
//     tickTimeFormat(d.date) + "</span> " ;
//  })
  
  
     var tip_deaths = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
     return tickTimeFormat(d.date) + "<br></br>Deaths: <span style='color:red'>" + d.deaths + "</span><br></br>" +
     "7-Day Average: <span style='color:red'>" + d.deaths_avg;
  })
//     return "<strong>Deaths:</strong> <span style='color:red'>" + d.deaths + "</span>";
//  })
  
       var tip_tests = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
     return tickTimeFormat(d.date) + "<br></br>Tests:<span style='color:red'>" + d.tested + "</span><br></br>" +
     "7-Day Average: <span style='color:red'>" + d.tests_avg;
  })
//     return "<strong>Tests:</strong> <span style='color:red'>" + d.tested + "</span>";
//  })
   
   svg_cases
    .attr("width", width_cases + margin_cases.left + margin_cases.right)
    .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin_cases.left + "," + margin_cases.top + ")");
   
   svg_cases.call(tip)
   
   svg_deaths
      .attr("width", width_cases + margin_cases.left + margin_cases.right)
      .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
   .append("g")
      .attr("transform", "translate(" + margin_cases.left + "," + margin_cases.top + ")");
      
   svg_deaths.call(tip_deaths)
   
      svg_test_pos
    .attr("width", width_cases + margin_cases.left + margin_cases.right)
    .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
 .append("g")
    .attr("transform",
          "translate(" + margin_cases.left + "," + margin_cases.top + ")");
          
   svg_tests
    .attr("width", width_cases + margin_cases.left + margin_cases.right)
    .attr("height", height_cases + margin_cases.top + margin_cases.bottom)
 .append("g")
    .attr("transform",
          "translate(" + margin_cases.left + "," + margin_cases.top + ")");
          
          svg_tests.call(tip_tests)
          
   // var data_map = historical_county.filter(function(d){return d.NOFO_Region==selectedGroupCases})
   
  const len = data_map.length - 1;

   x_cases
      .domain(data_map.map(function(d) { return d.date; }))
      .range([0,width_cases])
      .padding(0);
   
   x_test_pos
      .domain(data_map.map(function(d) { return d.date; }))
      .range([0,width_cases])
      .padding(0);
   
   x_tests
      .domain(data_map.map(function(d) { return d.date; }))
      .range([0,width_cases])
      .padding(0);
     
   var tickVals = x_cases.domain().filter(function(d,i){ return !(i%30)})
 
   if (currentWidth < 500) {
      var index = tickVals.length -1
      
      while (index >= 0) {
         if(index % 2 == 0  ){
            tickVals.splice(index, 1);
         }
         index -= 1;
      }
   }
 
 x_axis
//    .attr("transform", "translate(" + margin_cases.left + "," + (height_cases+margin_cases.top) + ")")
.attr("transform", "translate(" + margin_cases.left + "," + (height_cases + margin_cases.top) + ")")
   .call(d3.axisBottom(x_cases)
   //  .tickValues( x_cases.domain().filter(function(d,i){ return !(i%30)}))
   .tickValues(tickVals)
   .tickFormat(d3.timeFormat("%b %Y"))
   );

      
   //test pos chart x axis    
   x_axis_tests_pos
      // .attr("transform", "translate(" + margin_test_pos.left + "," + (height_cases+margin_test_pos.top) + ")")
      .attr("transform", "translate(" +  margin_cases.left + "," + (height_cases + margin_cases.top) + ")")
      .call(d3.axisBottom(x_test_pos)
      .tickValues(tickVals)
      .tickFormat(d3.timeFormat("%b %Y")));
          


   //tests chart x axis
   x_axis_tests
      // .attr("transform", "translate(" + margin_tests.left + "," + 0 + ")")
      .attr("transform", "translate(" + margin_cases.left + "," + (height_cases + margin_cases.top) + ")")
      .call(d3.axisBottom(x_tests)
      .tickValues(tickVals)
      .tickFormat(d3.timeFormat("%b %Y")));

   y_cases
      .domain([0, d3.max(data_map, function(d) { return d.cases; })])
      .range([height_cases, 0]);
   
   y_test_pos
      .domain([0, .30])
      .range([height_cases, 0]);
   
   y_tests
      .domain([0, d3.max(data_map, function(d) { return d.tested; })])
      .range([height_cases, 0]);
     
   y_axis
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  )
      .call(d3.axisLeft(y_cases));

   var formatPercent = d3.format(".0%");
   
   y_axis_tests_pos
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  )
      .call(d3.axisLeft(y_test_pos).tickFormat(formatPercent))
   
   y_axis_tests
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  )
      .call(d3.axisLeft(y_tests));
   
   var s = svg_tests.selectAll(".bar1")
                    .data(data_map)

   s
      .enter()
      .append("rect").merge(s)
      .attr("class", "bar1")
      .attr("x", function(d) { return x_tests(d.date)})
      .attr("y", function(d) { return y_tests(d.tested); })
      .attr("width",  x_tests.bandwidth())
      .attr("height", function(d) { return height_cases - y_tests(d.tested); })
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
            .on('mouseover', tip_tests.show)
      .on('mouseout', tip_tests.hide)
      .attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );
   s
      .exit()
      .remove()

   svg_tests
      .selectAll('path').remove();
   
   svg_tests
      .append('path')
      .datum(data_map)
      .attr('fill', 'none')
      .attr("stroke", function(d){ return colors(selectedRegion) })
      .attr('stroke-width', 2.5)
      .attr('stroke-linejoin', 'round')
      .attr('stroke-linecap', 'round')
      // .attr('d', line_test_daily)
            .attr("d", d3.line()
      .x(function(d) { return x_tests(d.date) })
      .y(function(d) { return y_tests(d.tests_avg) })
      )
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top + ")"  );
   
   svg_test_pos
      .selectAll("rect")
      .attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );


   svg_test_pos.selectAll('path').remove();
     
   svg_test_pos
      .append('path')
      .datum(data_map)
      .attr('fill', 'none')
      .attr("stroke", function(d){ return colors(selectedRegion) })
      .attr('stroke-width', 2.5)
      .attr('stroke-linejoin', 'round')
      .attr('stroke-linecap', 'round')
      // .attr('d', line_tests)
                  .attr("d", d3.line()
      .x(function(d) { return x_test_pos(d.date) })
      .y(function(d) { return y_test_pos(d.test_pos_avg) })
      )
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  );


  // Create the u variable
  var u = svg_cases.selectAll("rect").data(data_map)

  u
    .enter()
    .append("rect") // Add a new rect for each new elements
    .merge(u) // get the already existing elements as well
      .attr("x", function(d) { return x_cases(d.date); })
      .attr("y", function(d) { return y_cases(d.cases); })
      .attr("width", x_cases.bandwidth())
      .attr("height", function(d) { return height_cases - y_cases(d.cases); })
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
      .on('mouseover', tip.show)
      .on('mouseout', tip.hide)
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top + ")")

  u
    .exit()
    .remove()
    
   // u
   svg_cases
   .selectAll("rect")

   svg_cases.selectAll('path').remove();
  
   svg_cases
      .append('path')
      .datum(data_map)
      .attr('fill', 'none')
      .attr("stroke", function(d){ return colors(selectedRegion) })
      .attr('stroke-width', 2.5)
      .attr('stroke-linejoin', 'round')
      .attr('stroke-linecap', 'round')
      // .attr('d', line)
                        .attr("d", d3.line()
      .x(function(d) { return x_cases(d.date) })
      .y(function(d) { return y_cases(d.cases_avg) })
      )
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  );


   x_deaths
     .domain(data_map.map(function(d) { return d.date; }))
     .range([0,width_cases])
     .padding(0);


   x_axis_deaths
      .attr("transform", "translate(" + margin_cases.left + "," + (height_cases + margin_cases.top) + ")")
      .call(d3.axisBottom(x_deaths)
      .tickValues(tickVals)
      .tickFormat(d3.timeFormat("%b %Y")));

   y_deaths
      .domain([0, d3.max(data_map, function(d) { return d.deaths; })])
      .range([height_cases, 0]);

   y_axis_deaths
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top + ")"  )
      .call(d3.axisLeft(y_deaths));

  // Create the u variable
  var i = svg_deaths.selectAll("rect").data(data_map)

  i
    .enter()
    .append("rect") // Add a new rect for each new elements
    .merge(i) // get the already existing elements as well
      .attr("x", function(d) { return x_deaths(d.date); })
      .attr("y", function(d) { return y_deaths(d.deaths); })
      .attr("width", x_deaths.bandwidth())
      .attr("height", function(d) { return height_cases - y_deaths(d.deaths); })
      .attr("fill", function(d){ return lightestColors(selectedRegion) })
            .on('mouseover', tip_deaths.show)
      .on('mouseout', tip_deaths.hide)
      // .attr("transform", "translate("+ margin_cases.left +","+margin_cases.top + ")"  );

  i
    .exit()
    .remove()
    
   // u
   svg_deaths
   .selectAll("rect")
   // .attr("transform", "translate("+ margin_cases.left +","+0 + ")"  );
   .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  )
    


   svg_deaths.selectAll('path').remove();
   
   svg_deaths
      .append('path')
      .datum(data_map)
      .attr('fill', 'none')
      .attr("stroke", function(d){ return colors(selectedRegion) })
      .attr('stroke-width', 2.5)
      .attr('stroke-linejoin', 'round')
      .attr('stroke-linecap', 'round')
      // .attr('d', lineA)
      .attr("d", d3.line()
      .x(function(d) { return x_deaths(d.date) })
      .y(function(d) { return y_deaths(d.deaths_avg) })
      )
      .attr("transform", "translate("+ margin_cases.left +","+ margin_cases.top  + ")"  )
      
     
         document.getElementById('rt_text').innerHTML = (dataFilter[dataFilter.length - 1 ].rt_median).toFixed(2);
    document.getElementById('rt_text_lower').innerHTML = (dataFilter[dataFilter.length - 1 ].rt_lower).toFixed(2);
    document.getElementById('rt_text_upper').innerHTML = (dataFilter[dataFilter.length - 1 ].rt_upper).toFixed(2);
   //  document.getElementsByClassName('last_update_date').innerHTML = formatDate(data_map[data_map.length - 1 ].date)

    document.getElementById('avg_cases').innerHTML = data_map[data_map.length - 1 ].cases_avg
    document.getElementById('avg_deaths').innerHTML = data_map[data_map.length - 1 ].deaths_avg
    document.getElementById('avg_test').innerHTML = data_map[data_map.length - 1 ].tests_avg
    
    var region = ""
    if(selectedRegion == "illinois" ||selectedRegion == "Illinois" ) {
         // return "Illinois";
        region = "the state";
     } else {
        region = "Region " + selectedRegion.substring( selectedRegion.indexOf('_')+1);
     }
     
   //  document.getElementById('rt_text_region').innerHTML = region;
     
   var date_divs = document.getElementsByClassName( 'last_update_date' );
   var formatHTMLDate = d3.timeFormat("%B %d");
   
   [].slice.call( date_divs ).forEach(function ( div ) {
      div.innerHTML = formatHTMLDate(data_map[data_map.length - 1 ].date)
   });
   
   var reg_divs = document.getElementsByClassName( 'region_text' );
   
   [].slice.call( reg_divs ).forEach(function ( div ) {
      div.innerHTML = region
   });
      
    }
    // Initialize the chart
    drawChart();
    // Add an event listener that run the function when dimension change
    window.addEventListener('resize', drawChart ); 
          // When the button is changed, run the updateChart funso ction
    d3.select("#selectButton").on("change", function(d) {
      // recover the option that has been chosen
      // var selectedOption = d3.select(this).property("value")
       selectedRegion = d3.select(this).property("value")
      // run the updateChart function with this selected option
      drawChart()
    })
})

</script>